import{_ as s,c as a,o as n,a as o}from"./app.e18c80f2.js";const y=JSON.parse('{"title":"トラブルシューティングエラー","description":"","frontmatter":{},"headers":[{"level":3,"title":"**何か問題が発生したというエラーページが表示されるのですが。何が問題なのかを調べるにはどうしたらいいですか？","slug":"何か問題が発生したというエラーページが表示されるのですが。何が問題なのかを調べるにはどうしたらいいですか","link":"#何か問題が発生したというエラーページが表示されるのですが。何が問題なのかを調べるにはどうしたらいいですか","children":[]},{"level":3,"title":"**新しいバージョンにアップグレードした後、いくつかのページが奇妙に見え、スタイル化されていない要素があるように見えます。なぜでしょうか？","slug":"新しいバージョンにアップグレードした後、いくつかのページが奇妙に見え、スタイル化されていない要素があるように見えます。なぜでしょうか","link":"#新しいバージョンにアップグレードした後、いくつかのページが奇妙に見え、スタイル化されていない要素があるように見えます。なぜでしょうか","children":[]},{"level":3,"title":"**新しいバージョンにアップグレードした後、いくつかのリクエストが失敗し、ログにカラムやテーブルが見つからないというエラーメッセージが表示されます。なぜでしょうか？","slug":"新しいバージョンにアップグレードした後、いくつかのリクエストが失敗し、ログにカラムやテーブルが見つからないというエラーメッセージが表示されます。なぜでしょうか","link":"#新しいバージョンにアップグレードした後、いくつかのリクエストが失敗し、ログにカラムやテーブルが見つからないというエラーメッセージが表示されます。なぜでしょうか","children":[]},{"level":3,"title":"**tootctl や rake/rails コマンドを実行しようとしていますが、初期化されていない定数に関するエラーしか発生しません。どうしたのでしょうか？","slug":"tootctl-や-rake-rails-コマンドを実行しようとしていますが、初期化されていない定数に関するエラーしか発生しません。どうしたのでしょうか","link":"#tootctl-や-rake-rails-コマンドを実行しようとしていますが、初期化されていない定数に関するエラーしか発生しません。どうしたのでしょうか","children":[]},{"level":3,"title":"**RAILS_ENV=production bundle exec rails assets:precompile rails assets:precompileを実行中にコンパイルエラーが発生しました。 が、それ以上の情報はない。どうすれば直るのでしょうか **。","slug":"rails-env-production-bundle-exec-rails-assets-precompile-rails-assets-precompileを実行中にコンパイルエラーが発生しました。-が、それ以上の情報はない。どうすれば直るのでしょうか-。","link":"#rails-env-production-bundle-exec-rails-assets-precompile-rails-assets-precompileを実行中にコンパイルエラーが発生しました。-が、それ以上の情報はない。どうすれば直るのでしょうか-。","children":[]},{"level":2,"title":"データベースのインデックス破損","slug":"データベースのインデックス破損","link":"#データベースのインデックス破損","children":[{"level":3,"title":"ロケールデータと照合順序","slug":"ロケールデータと照合順序","link":"#ロケールデータと照合順序","children":[]},{"level":3,"title":"私はこの問題の影響を受けているのでしょうか？","slug":"私はこの問題の影響を受けているのでしょうか","link":"#私はこの問題の影響を受けているのでしょうか","children":[]},{"level":3,"title":"問題の修正","slug":"問題の修正","link":"#問題の修正","children":[]},{"level":3,"title":"問題の回避","slug":"問題の回避","link":"#問題の回避","children":[]}]}],"relativePath":"translation/mastodon/running/troubleshooting.md","lastUpdated":null}'),l={name:"translation/mastodon/running/troubleshooting.md"},e=o(`<h1 id="トラブルシューティングエラー" tabindex="-1">トラブルシューティングエラー <a class="header-anchor" href="#トラブルシューティングエラー" aria-hidden="true">#</a></h1><nav class="table-of-contents"><ul><li><a href="#何か問題が発生したというエラーページが表示されるのですが。何が問題なのかを調べるにはどうしたらいいですか">**何か問題が発生したというエラーページが表示されるのですが。何が問題なのかを調べるにはどうしたらいいですか？</a></li><li><a href="#新しいバージョンにアップグレードした後、いくつかのページが奇妙に見え、スタイル化されていない要素があるように見えます。なぜでしょうか">**新しいバージョンにアップグレードした後、いくつかのページが奇妙に見え、スタイル化されていない要素があるように見えます。なぜでしょうか？</a></li><li><a href="#新しいバージョンにアップグレードした後、いくつかのリクエストが失敗し、ログにカラムやテーブルが見つからないというエラーメッセージが表示されます。なぜでしょうか">**新しいバージョンにアップグレードした後、いくつかのリクエストが失敗し、ログにカラムやテーブルが見つからないというエラーメッセージが表示されます。なぜでしょうか？</a></li><li><a href="#tootctl-や-rake-rails-コマンドを実行しようとしていますが、初期化されていない定数に関するエラーしか発生しません。どうしたのでしょうか">**tootctl や rake/rails コマンドを実行しようとしていますが、初期化されていない定数に関するエラーしか発生しません。どうしたのでしょうか？</a></li><li><a href="#rails-env-production-bundle-exec-rails-assets-precompile-rails-assets-precompileを実行中にコンパイルエラーが発生しました。-が、それ以上の情報はない。どうすれば直るのでしょうか-。">**RAILS_ENV=production bundle exec rails assets:precompile rails assets:precompileを実行中にコンパイルエラーが発生しました。 が、それ以上の情報はない。どうすれば直るのでしょうか **。</a></li><li><a href="#データベースのインデックス破損">データベースのインデックス破損</a><ul><li><a href="#ロケールデータと照合順序">ロケールデータと照合順序</a></li><li><a href="#私はこの問題の影響を受けているのでしょうか">私はこの問題の影響を受けているのでしょうか？</a></li><li><a href="#問題の修正">問題の修正</a></li><li><a href="#問題の回避">問題の回避</a></li></ul></li></ul></nav><h3 id="何か問題が発生したというエラーページが表示されるのですが。何が問題なのかを調べるにはどうしたらいいですか" tabindex="-1">**何か問題が発生したというエラーページが表示されるのですが。何が問題なのかを調べるにはどうしたらいいですか？ <a class="header-anchor" href="#何か問題が発生したというエラーページが表示されるのですが。何が問題なのかを調べるにはどうしたらいいですか" aria-hidden="true">#</a></h3><p>スタックトレース付きの全てのエラーメッセージはシステムログに書き込まれます。systemd を使っている場合、各 systemd サービスのログは <code>journalctl -u mastodon-web</code> (正しいサービス名で置き換えてください) で参照することができます。Docker を使用している場合は、<code>docker logs mastodon_web_1</code> (正しいコンテナ名に置き換えてください) で同様のことができます。</p><p>サーバーサイドのエラーの詳細は、決して一般に公開されません。</p><p>マストドンのウェブサーバーからの各レスポンスには、固有のリクエストIDを持つヘッダーがあり、これはログにも反映される。エラーページのヘッダーを検査することで、対応するスタックトレースを簡単にログで見つけることができる。</p><h3 id="新しいバージョンにアップグレードした後、いくつかのページが奇妙に見え、スタイル化されていない要素があるように見えます。なぜでしょうか" tabindex="-1">**新しいバージョンにアップグレードした後、いくつかのページが奇妙に見え、スタイル化されていない要素があるように見えます。なぜでしょうか？ <a class="header-anchor" href="#新しいバージョンにアップグレードした後、いくつかのページが奇妙に見え、スタイル化されていない要素があるように見えます。なぜでしょうか" aria-hidden="true">#</a></h3><p>アップグレード後に <code>RAILS_ENV=production bin/rails assets:precompile</code> を実行したか確認し、Mastodon のウェブプロセスを再起動してください。古いスタイルシートやスクリプトが提供されているように見えるからです。また、webpackは残念ながら非常にメモリを消費するため、RAM不足でプリコンパイルが失敗する可能性もあります。そのような場合は、スワップ領域を確保してください。あるいは、別のマシンでアセットをプリコンパイルし、<code>public/packs</code>ディレクトリにコピーすることも可能です。</p><h3 id="新しいバージョンにアップグレードした後、いくつかのリクエストが失敗し、ログにカラムやテーブルが見つからないというエラーメッセージが表示されます。なぜでしょうか" tabindex="-1">**新しいバージョンにアップグレードした後、いくつかのリクエストが失敗し、ログにカラムやテーブルが見つからないというエラーメッセージが表示されます。なぜでしょうか？ <a class="header-anchor" href="#新しいバージョンにアップグレードした後、いくつかのリクエストが失敗し、ログにカラムやテーブルが見つからないというエラーメッセージが表示されます。なぜでしょうか" aria-hidden="true">#</a></h3><p>アップグレード後に <code>RAILS_ENV=production bin/rails db:migrate</code> を実行したか確認してください。Mastodonのコードが新しいか古いデータベーススキーマにアクセスしているように見えるからです。PgBouncerを使用している場合、PgBouncerはマイグレーションで使用されるテーブルロックをサポートしていないので、このコマンドがPostgreSQLに直接接続することを確認してください。</p><h3 id="tootctl-や-rake-rails-コマンドを実行しようとしていますが、初期化されていない定数に関するエラーしか発生しません。どうしたのでしょうか" tabindex="-1">**<code>tootctl</code> や <code>rake</code>/<code>rails</code> コマンドを実行しようとしていますが、初期化されていない定数に関するエラーしか発生しません。どうしたのでしょうか？ <a class="header-anchor" href="#tootctl-や-rake-rails-コマンドを実行しようとしていますが、初期化されていない定数に関するエラーしか発生しません。どうしたのでしょうか" aria-hidden="true">#</a></h3><p>コマンドの前に <code>RAILS_ENV=production</code> と正しい環境が指定されているか確認してください。デフォルトでは、環境は開発環境とみなされ、開発関連のgemsをロードしようとします。しかし、本番環境ではそれらのgemsのインストールを避けるので、そこからエラーが発生します。</p><h3 id="rails-env-production-bundle-exec-rails-assets-precompile-rails-assets-precompileを実行中にコンパイルエラーが発生しました。-が、それ以上の情報はない。どうすれば直るのでしょうか-。" tabindex="-1">**<code>RAILS_ENV=production bundle exec rails assets:precompile</code> rails assets:precompileを実行中にコンパイルエラーが発生しました。 が、それ以上の情報はない。どうすれば直るのでしょうか **。 <a class="header-anchor" href="#rails-env-production-bundle-exec-rails-assets-precompile-rails-assets-precompileを実行中にコンパイルエラーが発生しました。-が、それ以上の情報はない。どうすれば直るのでしょうか-。" aria-hidden="true">#</a></h3><p>通常、アセットをコンパイルしている間にサーバーがメモリ不足になったことが原因です。swapfileを使用するか、スワップ領域を増やしてメモリ容量を増やしてください。<code>RAILS_ENV=production bundle exec rake tmp:cache:clear</code> を実行してキャッシュをクリアし、次に <code>RAILS_ENV=production bundle exec rails assets:precompile</code> を実行して再度コンパイルしてください。コンパイルエラーの後にキャッシュをクリアすることを確認してください。さもないと、「Everything&#39;s OK」と表示されますが、アセットは変更されないままです。</p><h2 id="データベースのインデックス破損" tabindex="-1">データベースのインデックス破損 <a class="header-anchor" href="#データベースのインデックス破損" aria-hidden="true">#</a></h2><p>データベースのインデックス破損から復旧する方法</p><p>やや一般的な設定の問題で、データベース全体のインデックスが破損することがあります。このページでは、これが発生する理由とその修正方法について説明します。</p><h3 id="ロケールデータと照合順序" tabindex="-1">ロケールデータと照合順序 <a class="header-anchor" href="#ロケールデータと照合順序" aria-hidden="true">#</a></h3><p>データベース内のテキスト値、例えばユーザー名や状態識別子は、いわゆる照合順序や大文字小文字の変更方法を定義した照合規則を用いて比較されます。 データベースをセットアップする際、Mastodon はデータベースサーバーのデフォルトのロケール設定を使用し、デフォルトの照合順序ルールも使用します。</p><p>残念ながら、2018年後半、<code>glibc</code>のアップデートにより、多くのロケールの照合規則が変更され、影響を受けるロケールを使用しているデータベースでは、テキスト値の順序が異なるようになりました。 データベースのインデックスは、インデックスを作成する値の順序に依存するアルゴリズム構造であるため、その一部が不整合になるのです。</p><p>詳細はこちら: <a href="https://wiki.postgresql.org/wiki/Locale_data_changes" target="_blank" rel="noreferrer">https://wiki.postgresql.org/wiki/Locale_data_changes</a> <a href="https://postgresql.verite.pro/blog/2018/08/27/glibc-upgrade.html" target="_blank" rel="noreferrer">https://postgresql.verite.pro/blog/2018/08/27/glibc-upgrade.html</a></p><h3 id="私はこの問題の影響を受けているのでしょうか" tabindex="-1">私はこの問題の影響を受けているのでしょうか？ <a class="header-anchor" href="#私はこの問題の影響を受けているのでしょうか" aria-hidden="true">#</a></h3><p>照合順序の設定に <code>C</code> または <code>POSIX</code> を使用していない場合（<code>SELECT datcollate FROM pg_database WHERE datname = current_database();</code> でチェックできます）。 glibc 2.28より前のバージョンで実行していて、glibc 2.28以降に更新した後にすぐにデータベースのインデックスを再作成しなかった場合、インデックスに不整合が生じる可能性があります。</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>このページは、&quot;Duplicate Indexes&quot; に関する <strong>PgHero</strong> の警告のために訪れたかもしれません。このような警告は、Mastodonのデプロイやアップデートに問題があることを示している場合がありますが、 <strong>データベースのインデックス破損とは関係ありませんし、データベースの機能的な問題を示すものではありません</strong>。</p></div><p>インデックスが整合しているかどうかは、<a href="https://www.postgresql.org/docs/10/amcheck.html" target="_blank" rel="noreferrer">PostgreSQL の <code>amcheck</code> モジュール</a> を使って確認できます。データベースサーバのスーパーユーザとして、Mastodon データベースに接続し、次のように実行してください（しばらく時間がかかるかもしれません）。</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> EXTENSION </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> amcheck;</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> bt_index_check(c.oid)</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> pg_index i</span></span>
<span class="line"><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> pg_class c </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> i.indexrelid </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> c.oid</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> c.relname </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_account_domain_blocks_on_account_id_and_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_account_proofs_on_account_and_provider_and_username</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_accounts_on_username_and_domain_lower</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_accounts_on_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_accounts_on_url</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_conversations_on_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_custom_emoji_categories_on_name</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_custom_emojis_on_shortcode_and_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_devices_on_access_token_id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_domain_allows_on_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_domain_blocks_on_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_email_domain_blocks_on_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_invites_on_code</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_markers_on_user_id_and_timeline</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_media_attachments_on_shortcode</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_preview_cards_on_url</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_statuses_on_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_tags_on_name_lower</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_tombstones_on_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_unavailable_domains_on_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_users_on_email</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_webauthn_credentials_on_external_id</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">);</span></span>
<span class="line"></span></code></pre></div><p>これでエラーが発生した場合は、データベースが破損しており、修復が必要です。そうでない場合は、より詳細なチェックを行う必要があるかもしれません。 これまでのチェックとは異なり、これらのチェックは実行時にテーブルをロックするため、インスタンスの可用性に支障をきたします。</p><div class="language-SQL"><button title="Copy Code" class="copy"></button><span class="lang">SQL</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> EXTENSION </span><span style="color:#F78C6C;">IF</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">NOT</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">EXISTS</span><span style="color:#A6ACCD;"> amcheck;</span></span>
<span class="line"><span style="color:#F78C6C;">SELECT</span><span style="color:#A6ACCD;"> bt_index_parent_check(c.oid)</span></span>
<span class="line"><span style="color:#F78C6C;">FROM</span><span style="color:#A6ACCD;"> pg_index i</span></span>
<span class="line"><span style="color:#F78C6C;">JOIN</span><span style="color:#A6ACCD;"> pg_class c </span><span style="color:#F78C6C;">ON</span><span style="color:#A6ACCD;"> i.indexrelid </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> c.oid</span></span>
<span class="line"><span style="color:#F78C6C;">WHERE</span><span style="color:#A6ACCD;"> c.relname </span><span style="color:#F78C6C;">IN</span><span style="color:#A6ACCD;"> (</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_account_domain_blocks_on_account_id_and_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_account_proofs_on_account_and_provider_and_username</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_accounts_on_username_and_domain_lower</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_accounts_on_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_accounts_on_url</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_conversations_on_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_custom_emoji_categories_on_name</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_custom_emojis_on_shortcode_and_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_devices_on_access_token_id</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_domain_allows_on_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_domain_blocks_on_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_email_domain_blocks_on_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_invites_on_code</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_markers_on_user_id_and_timeline</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_media_attachments_on_shortcode</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_preview_cards_on_url</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_statuses_on_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_tags_on_name_lower</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_tombstones_on_uri</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_unavailable_domains_on_domain</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_users_on_email</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">, </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">index_webauthn_credentials_on_external_id</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">);</span></span>
<span class="line"></span></code></pre></div><p>これが成功し、エラーを返さなければ、データベースの整合性が保たれ、Mastodonが <code>db:migrate</code> を実行する際に出す警告を無視しても大丈夫です。</p><h3 id="問題の修正" tabindex="-1">問題の修正 <a class="header-anchor" href="#問題の修正" aria-hidden="true">#</a></h3><p>この問題が発生した場合、対策を講じない限り、時間が経つにつれてデータベースの整合性が取れなくなる可能性があります。そのため、できるだけ早く修正することが重要です。</p><p>Mastodon 3.2.2以降には、これらの破損を可能な限り修正するための半対話型スクリプトが付属しています。それ以前のバージョンを使っている場合は、まず 3.2.2 にアップデートしてください。3.2.2へのデータベース移行は、そのような破損のために失敗する可能性がありますが、Mastodon 3.2.2に付属するメンテナンスツールで回復できる状態にする必要があります。</p><p>データベースの修復を試みる前に、<strong>Mastodon を停止してデータベースのバックアップをとってください</strong>。その後、<strong>Mastodon を停止したまま</strong>、メンテナンススクリプトを実行します。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">RAILS_ENV=production tootctl maintenance fix-duplicates</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>このスクリプトは、データベースの中を歩いて、自動的に重複を見つけ、修正します。場合によっては、それらの操作は破壊的である。最も破壊的なケースでは、どのレコードを残し、どのレコードを破棄するかを選択するように要求される。いずれの場合も、重複を探すためにデータベース全体を歩き回るのは、非常に長い操作となる。</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>場合によっては、重複したレコードに両立しない競合が発生することがあります（たとえば、2つの異なるローカルユーザーが同じユーザー名を共有している場合など）。このような場合、重複排除操作は<strong>部分的に破壊的</strong>になることがあり、どのレコードを変更せず、どのレコードを変更するかを尋ねられる。 したがって、このスクリプトは半対話的である。どのような場合でも、重複を検索するためにデータベース全体を歩き回ることは非常に長い操作である。</p></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p><strong>メンテナンススクリプトは一時的にインデックスを削除するため、追加の重複が発生しないよう、全工程でMastodonを完全に停止する必要があります</strong>。</p></div><h3 id="問題の回避" tabindex="-1">問題の回避 <a class="header-anchor" href="#問題の回避" aria-hidden="true">#</a></h3><p>この問題を回避するには、libc の更新後すぐにデータベースのインデックスを再作成してください。 <a href="https://www.postgresql.org/docs/current/sql-reindex.html" target="_blank" rel="noreferrer">SQL コマンド <code>REINDEX</code></a> や <a href="https://www.postgresql.org/docs/current/app-reindexdb.html" target="_blank" rel="noreferrer"><code>reindexdb</code> コマンドラインツール</a> が役に立つかもしれません。</p>`,39),p=[e];function c(t,r,i,D,d,C){return n(),a("div",null,p)}const F=s(l,[["render",c]]);export{y as __pageData,F as default};
