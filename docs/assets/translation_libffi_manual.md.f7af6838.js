import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.92ce8a2a.js";const F=JSON.parse('{"title":"libffi","description":"","frontmatter":{},"headers":[],"relativePath":"translation/libffi/manual.md","filePath":"translation/libffi/manual.md","lastUpdated":null}'),p={name:"translation/libffi/manual.md"},o=l(`<h1 id="libffi" tabindex="-1">libffi <a class="header-anchor" href="#libffi" aria-label="Permalink to &quot;libffi&quot;">​</a></h1><p>ポータブル外部関数インターフェイスライブラリ</p><p>本マニュアルは、ポータブルな外部関数インターフェイスライブラリであるlibffiライブラリのためのものです。</p><h2 id="コピーライト" tabindex="-1">コピーライト <a class="header-anchor" href="#コピーライト" aria-label="Permalink to &quot;コピーライト&quot;">​</a></h2><p>Copyright 2008--2019, 2021, 2022 Anthony Green and Red Hat, Inc.</p><p>本ソフトウェアおよび関連文書ファイル（以下「本ソフトウェア」）の複製物を入手する者に対し、本ソフトウェアの複製物の使用、複製、変更、結合、出版、頒布、サブライセンス、および/または販売する権利を含むがこれらに限定されない、本ソフトウェアを無制限に取り扱うこと、および本ソフトウェアを提供される者にこれを許可することを、以下の条件に従い、無償で許可します：</p><p>上記の著作権表示および本許諾表示は、本ソフトウェアのすべての複製物または相当部分に含まれるものとします。</p><p>THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p><h2 id="libffiとは" tabindex="-1">libffiとは？ <a class="header-anchor" href="#libffiとは" aria-label="Permalink to &quot;libffiとは？&quot;">​</a></h2><p>高級言語用のコンパイラーは、特定の規約に従ったコードを生成する。これらの規約は、部分的には、個別コンパイルが機能するために必要なものである。 そのような規約のひとつに呼び出し規約がある。 呼び出し規約とは、関数の引数が関数に入るときにどこにあるかをコンパイラが仮定したものです。 呼び出し規約はまた、関数の戻り値がどこにあるかについても指定します。 呼び出し規約はABI（Application Binary Interface）と呼ばれることもあります。</p><p>プログラムによっては、関数にどのような引数を渡せばよいのか、コンパイル時に分からない場合があります。 libffiは、このようなプログラムにおいて、インタプリタ・プログラムからコンパイル済みコードへの橋渡しをするために使用することができます。</p><p>libffiライブラリーは、さまざまな呼び出し規約に対する移植性の高い高レベルプログラミングインターフェースを提供する。 これにより、プログラマーは実行時に呼び出しインターフェイス記述で指定された任意の関数を呼び出すことができます。</p><p>FFIとは、Foreign Function Interface（外国関数インターフェース）の略です。 外国関数インターフェースは、ある言語で書かれたコードが別の言語で書かれたコードを呼び出すことを可能にするインターフェースの一般的な名称です。libffiライブラリーは、実際には、完全な機能を持つ外部関数インターフェースの最下層、マシン依存のレイヤーを提供するだけである。 libffiの上には、2つの言語間で渡される値の型変換を処理する層が存在しなければならない。</p><h2 id="基本" tabindex="-1">基本 <a class="header-anchor" href="#基本" aria-label="Permalink to &quot;基本&quot;">​</a></h2><p>libffiは、呼び出したい関数へのポインタがあり、その関数に渡す引数の数と型、関数の戻り値の型がわかっていることを前提としています。</p><p>最初にしなければならないことは、呼び出したい関数のシグネチャにマッチするffi_cifオブジェクトを作成することです。 一つのffi_cifを使って複数の呼び出しを行うのが一般的なので、これは別のステップです。 ffi_cifのcifはCall InterFaceの略である。 コール・インターフェイス・オブジェクトを準備するには、関数ffi_prep_cifを使用する。</p><h3 id="cif" tabindex="-1">cif <a class="header-anchor" href="#cif" aria-label="Permalink to &quot;cif&quot;">​</a></h3><h4 id="ffi-prep-cif" tabindex="-1"><code>ffi_prep_cif()</code> <a class="header-anchor" href="#ffi-prep-cif" aria-label="Permalink to &quot;\`ffi_prep_cif()\`&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ffi_status </span><span style="color:#B392F0;">ffi_prep_cif</span><span style="color:#E1E4E8;"> (ffi_cif </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">cif</span><span style="color:#E1E4E8;">, ffi_abi </span><span style="color:#FFAB70;">abi</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">unsigned</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">nargs</span><span style="color:#E1E4E8;">, ffi_type </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">rtype</span><span style="color:#E1E4E8;">, ffi_type </span><span style="color:#F97583;">**</span><span style="color:#FFAB70;">argtypes</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ffi_status </span><span style="color:#6F42C1;">ffi_prep_cif</span><span style="color:#24292E;"> (ffi_cif </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">cif</span><span style="color:#24292E;">, ffi_abi </span><span style="color:#E36209;">abi</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">unsigned</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">nargs</span><span style="color:#24292E;">, ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">rtype</span><span style="color:#24292E;">, ffi_type </span><span style="color:#D73A49;">**</span><span style="color:#E36209;">argtypes</span><span style="color:#24292E;">)</span></span></code></pre></div><p>与えられたパラメーターに従ってcifを初期化する。</p><ul><li>abiは使用するABIで、通常はFFI_DEFAULT_ABIを使用する。 通常はFFI_DEFAULT_ABIを使用する。</li><li>nargsは、この関数が受け付ける引数の数です。</li><li>rtypeは、関数の戻り値の型を表すffi_type構造体へのポインタです。 型。</li><li>argtypesはffi_typeポインタのベクトルである。argtypesはnargs要素を持たなければならない。 nargsが0の場合、この引数は無視される。</li></ul><p>ffi_prep_cifはffi_status型のlibffiステータスコードを返す。 ffi_typeオブジェクトが正しくない場合はFFI_BAD_TYPEDEF、 abiパラメータが無効な場合はFFI_BAD_ABIとなる。</p><p>呼び出される関数がバリアディック(varargs)の場合、ffi_prep_cifの代わりにffi_prep_cif_varを使わなければならない。</p><h4 id="ffi-prep-cif-var" tabindex="-1"><code>ffi_prep_cif_var()</code> <a class="header-anchor" href="#ffi-prep-cif-var" aria-label="Permalink to &quot;\`ffi_prep_cif_var()\`&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ffi_status </span><span style="color:#B392F0;">ffi_prep_cif_var</span><span style="color:#E1E4E8;"> (ffi_cif </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">cif</span><span style="color:#E1E4E8;">, ffi_abi </span><span style="color:#FFAB70;">abi</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">unsigned</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">nfixedargs</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">unsigned</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">ntotalargs</span><span style="color:#E1E4E8;">, ffi_type </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">rtype</span><span style="color:#E1E4E8;">, ffi_type </span><span style="color:#F97583;">**</span><span style="color:#FFAB70;">argtypes</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ffi_status </span><span style="color:#6F42C1;">ffi_prep_cif_var</span><span style="color:#24292E;"> (ffi_cif </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">cif</span><span style="color:#24292E;">, ffi_abi </span><span style="color:#E36209;">abi</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">unsigned</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">nfixedargs</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">unsigned</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#E36209;">ntotalargs</span><span style="color:#24292E;">, ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">rtype</span><span style="color:#24292E;">, ffi_type </span><span style="color:#D73A49;">**</span><span style="color:#E36209;">argtypes</span><span style="color:#24292E;">)</span></span></code></pre></div><p>これは、与えられたパラメータに従ってcifを初期化するもので、バリアド関数の呼び出しに対応する。 一般的に、この操作はffi_prep_cifと同じである。:</p><ul><li>nfixedargsは、可変引数の前の固定引数の数である。 ゼロより大きくなければならない。</li><li>ntotalargs 変数引数と固定引数を含む引数の総数。 argtypesはこれだけの要素を持たなければならない。</li></ul><p>ffi_prep_cif_var は、変数引数の型が ffi_type_float (最初に ffi_type_double に昇格)、または int よりも小さい整数型 (最初に int サイズの型に昇格) の場合、FFI_BAD_ARGTYPE を返す。</p><p>異なる数の引数が渡された場合、同じ関数の呼び出しに対して異なるcifを準備しなければならないことに注意。</p><p>また、ffi_prep_cif_varをnfixedargs=nototalargsで呼び出すことは、ffi_prep_cifを呼び出すことと等価ではないことに注意。</p><p>結果として得られるffi_cifは、初期化時に使用されたすべてのffi_typeオブジェクトへのポインタを保持していることに注意してください。 これらの型オブジェクトの寿命は、少なくともffi_cifの寿命と同じになるようにしなければならない。</p><p>初期化されたffi_cifを使って関数を呼び出すには、ffi_call関数を使います：</p><h4 id="ffi-call" tabindex="-1"><code>ffi_call()</code> <a class="header-anchor" href="#ffi-call" aria-label="Permalink to &quot;\`ffi_call()\`&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ffi_call</span><span style="color:#E1E4E8;"> (ffi_cif </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">cif</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">fn</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">rvalue</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">**</span><span style="color:#FFAB70;">avalues</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ffi_call</span><span style="color:#24292E;"> (ffi_cif </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">cif</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">fn</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">rvalue</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">**</span><span style="color:#E36209;">avalues</span><span style="color:#24292E;">)</span></span></code></pre></div><p>これは、cifで与えられた説明に従って関数fnを呼び出す。 cifはすでにffi_prep_cifで準備されていなければならない。</p><p>rvalueは、関数呼び出しの結果を保持するメモリチャンクへのポインタである。 これは、結果を保持するのに十分な大きさでなければならず、システム・レジスタ・サイズ（一般に32ビットまたは64ビット）より小さくはならず、適切にアラインされていなければならない。 cifが（ffi_type_voidを使って）関数はvoidを返すと宣言した場合、rvalueは無視される。</p><p>ほとんどの場合、libffiはABIに従ってプロモーションを処理する。 しかし、歴史的な理由から、コードで処理しなければならない戻り値の特殊なケースがある。 特に、システム・レジスタ・サイズより狭い積分型（構造体ではない）については、libffiによって返り値が広げられる。 libffiはffi_argという戻り値型として使える型を提供している。 例えば、CIFがcharの戻り値型で定義された場合、libffiは完全なffi_argを戻り値に格納しようとする。</p><p>avaluesは@code{void *}ポインタのベクトルで、呼び出しの引数値を保持するメモリ・ロケーションを指す。 cifが関数に引数がないと宣言した場合（つまりnargsが0だった場合）、avaluesは無視される。</p><p>戻り値はレジスタサイズでなければならないが、引数は宣言された型と正確に一致しなければならないことに注意。 例えば、引数がshortの場合、avaluesのエントリーはshortとして宣言されたオブジェクトを指すべきである。しかし、戻り値の型がshortの場合、rvalueはより大きな型として宣言されたオブジェクト（通常はffi_arg）を指すべきである。</p><h2 id="簡単な例" tabindex="-1">簡単な例 <a class="header-anchor" href="#簡単な例" aria-label="Permalink to &quot;簡単な例&quot;">​</a></h2><p>以下は、プットを数回呼び出す些細な例である。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;stdio.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;ffi.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_cif cif;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_type </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">values</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">char</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">s;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_arg rc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Initialize the argument info vectors */</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_pointer;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">values</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">s;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Initialize the cif */</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ffi_prep_cif</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cif, FFI_DEFAULT_ABI, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">		       </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_sint, args) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> FFI_OK)</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">      s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Hello World!&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">ffi_call</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cif, puts, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">rc, values);</span></span>
<span class="line"><span style="color:#6A737D;">      /* rc now holds the result of the call to puts */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">      /* values holds a pointer to the function&#39;s arg, so to</span></span>
<span class="line"><span style="color:#6A737D;">         call puts() again all we need to do is change the</span></span>
<span class="line"><span style="color:#6A737D;">         value of s */</span></span>
<span class="line"><span style="color:#E1E4E8;">      s </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;This is cool!&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">ffi_call</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cif, puts, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">rc, values);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;stdio.h&gt;</span></span>
<span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;ffi.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  ffi_cif cif;</span></span>
<span class="line"><span style="color:#24292E;">  ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">values</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">char</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">s;</span></span>
<span class="line"><span style="color:#24292E;">  ffi_arg rc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Initialize the argument info vectors */</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_pointer;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">values</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">s;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Initialize the cif */</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ffi_prep_cif</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cif, FFI_DEFAULT_ABI, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">		       </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_sint, args) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> FFI_OK)</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">      s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Hello World!&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">ffi_call</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cif, puts, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">rc, values);</span></span>
<span class="line"><span style="color:#6A737D;">      /* rc now holds the result of the call to puts */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">      /* values holds a pointer to the function&#39;s arg, so to</span></span>
<span class="line"><span style="color:#6A737D;">         call puts() again all we need to do is change the</span></span>
<span class="line"><span style="color:#6A737D;">         value of s */</span></span>
<span class="line"><span style="color:#24292E;">      s </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;This is cool!&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">ffi_call</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cif, puts, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">rc, values);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h2 id="型" tabindex="-1">型 <a class="header-anchor" href="#型" aria-label="Permalink to &quot;型&quot;">​</a></h2><h3 id="プリミティブ・タイプ" tabindex="-1">プリミティブ・タイプ <a class="header-anchor" href="#プリミティブ・タイプ" aria-label="Permalink to &quot;プリミティブ・タイプ&quot;">​</a></h3><p>Libffiは、引数や戻り値の型を記述するために使用できる多くの組み込み型記述子を提供しています：</p><table><thead><tr><th>名前</th><th>説明</th></tr></thead><tbody><tr><td>ffi_type_void</td><td>The type void. This cannot be used for argument types, only for return values.</td></tr><tr><td>ffi_type_uint8</td><td>An unsigned, 8-bit integer type.</td></tr><tr><td>ffi_type_sint8</td><td>A signed, 8-bit integer type.</td></tr><tr><td>ffi_type_uint16</td><td>An unsigned, 16-bit integer type.</td></tr><tr><td>ffi_type_sint16</td><td>A signed, 16-bit integer type.</td></tr><tr><td>ffi_type_uint32</td><td>An unsigned, 32-bit integer type.</td></tr><tr><td>ffi_type_sint32</td><td>A signed, 32-bit integer type.</td></tr><tr><td>ffi_type_uint64</td><td>An unsigned, 64-bit integer type.</td></tr><tr><td>ffi_type_sint64</td><td>A signed, 64-bit integer type.</td></tr><tr><td>ffi_type_float</td><td>The C float type.</td></tr><tr><td>ffi_type_double</td><td>The C double type.</td></tr><tr><td>ffi_type_uchar</td><td>The C unsigned char type.</td></tr><tr><td>ffi_type_schar</td><td>The C signed char type. (Note that there is not an exact equivalent to the C char type in libffi; ordinarily you should either use ffi_type_schar or ffi_type_uchar depending on whether char is signed.)</td></tr><tr><td>ffi_type_ushort</td><td>The C unsigned short type.</td></tr><tr><td>ffi_type_sshort</td><td>The C short type.</td></tr><tr><td>ffi_type_uint</td><td>The C unsigned int type.</td></tr><tr><td>ffi_type_sint</td><td>The C int type.</td></tr><tr><td>ffi_type_ulong</td><td>The C unsigned long type.</td></tr><tr><td>ffi_type_slong</td><td>The C long type.</td></tr><tr><td>ffi_type_longdouble</td><td>On platforms that have a C long double type, this is defined. On other platforms, it is not.</td></tr><tr><td>ffi_type_pointer</td><td>A generic <code>void *</code> pointer. You should use this for all pointers, regardless of their real type.</td></tr><tr><td>ffi_type_complex_float</td><td>The C _Complex float type.</td></tr><tr><td>ffi_type_complex_double</td><td>The C _Complex double type.</td></tr><tr><td>ffi_type_complex_longdouble</td><td>The C _Complex long double type. On platforms that have a C long double type, this is defined. On other platforms, it is not.</td></tr></tbody></table><p>それぞれffi_type型なので、ffi_prep_cifに渡すときはアドレスを取る必要がある。</p><h3 id="構造体" tabindex="-1">構造体 <a class="header-anchor" href="#構造体" aria-label="Permalink to &quot;構造体&quot;">​</a></h3><p>libffi は構造体の受け渡しを完璧にこなします。まず、 libffi に新しい ffi_type オブジェクトを作成して構造を記述する必要があります。</p><h4 id="ffi-type" tabindex="-1">ffi_type <a class="header-anchor" href="#ffi-type" aria-label="Permalink to &quot;ffi_type&quot;">​</a></h4><p>ffi_typeには以下のメンバがある。:</p><table><thead><tr><th>メンバ</th><th>説明</th></tr></thead><tbody><tr><td>size_t size</td><td>これはlibffiによって設定されるので、ゼロに初期化する必要がある。</td></tr><tr><td>unsigned short alignment</td><td>これはlibffiによって設定されるので、ゼロに初期化する必要がある。</td></tr><tr><td>unsigned short type</td><td>構造体の場合は、FFI_TYPE_STRUCT に設定する。</td></tr><tr><td>ffi_type **elements</td><td>これはffi_typeオブジェクトへのポインタのNULL終端の配列である。 構造体のフィールドごとに1つの要素があります。</td></tr></tbody></table><p>libffiはビットフィールドを特別にサポートしていないことに注意。 これらを手動で管理する必要がある。</p><p>サイズとアライメントのフィールドは、必要に応じてffi_prep_cifまたはffi_prep_cif_varによって埋められる。</p><h3 id="サイズとアライメント" tabindex="-1">サイズとアライメント <a class="header-anchor" href="#サイズとアライメント" aria-label="Permalink to &quot;サイズとアライメント&quot;">​</a></h3><p>libffiはffi_typeオブジェクトのサイズとアライメントのフィールドをあなたに代わって設定します。 これは の知識を使って行います。</p><p>libffiによって設定された型に対して、これらのフィールドを単純に読み取ることができると思うかもしれない。 しかし、いくつかの注意点がある。</p><ul><li>いくつかの組み込み型のサイズやアライメントは、選択したABIによって異なる場合がある。</li><li>新しい構造体タイプのサイズとアライメントは、ffi_prep_cif または ffi_get_struct_offsets に渡されるまで libffi によって設定されない。</li><li>構造体タイプをABI間で共有することはできない。 代わりに、各ABIは構造体型の独自のコピーを必要とする。</li></ul><p>したがって、これらのフィールドを調べる前に、まずffi_typeオブジェクトをffi_prep_cifかffi_get_struct_offsetsに渡すのが一番安全である。 この関数は必要なセットアップをすべて行ってくれる。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ffi_type </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">desired_type;</span></span>
<span class="line"><span style="color:#E1E4E8;">ffi_abi desired_abi;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">ffi_cif cif;</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ffi_prep_cif</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">&amp;</span><span style="color:#FFAB70;">cif</span><span style="color:#E1E4E8;">, desired_abi, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, desired_type, </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> FFI_OK)</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> desired_type-&gt;size;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">unsigned</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">short</span><span style="color:#E1E4E8;"> alignment </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> desired_type-&gt;alignment;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">desired_type;</span></span>
<span class="line"><span style="color:#24292E;">ffi_abi desired_abi;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">ffi_cif cif;</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ffi_prep_cif</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">&amp;</span><span style="color:#E36209;">cif</span><span style="color:#24292E;">, desired_abi, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, desired_type, </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> FFI_OK)</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> desired_type-&gt;size;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">unsigned</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">short</span><span style="color:#24292E;"> alignment </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> desired_type-&gt;alignment;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>libffiは、構造体のメンバーのオフセットを取得する方法も提供している。</p><h4 id="ffi-get-struct-offsets" tabindex="-1"><code>ffi_get_struct_offsets()</code> <a class="header-anchor" href="#ffi-get-struct-offsets" aria-label="Permalink to &quot;\`ffi_get_struct_offsets()\`&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ffi_status </span><span style="color:#B392F0;">ffi_get_struct_offsets</span><span style="color:#E1E4E8;"> (ffi_abi </span><span style="color:#FFAB70;">abi</span><span style="color:#E1E4E8;">, ffi_type </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">struct_type</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">offsets</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ffi_status </span><span style="color:#6F42C1;">ffi_get_struct_offsets</span><span style="color:#24292E;"> (ffi_abi </span><span style="color:#E36209;">abi</span><span style="color:#24292E;">, ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">struct_type</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">offsets</span><span style="color:#24292E;">)</span></span></code></pre></div><p>指定された構造体タイプの各要素のオフセットを計算する。abiは使用するABIで、レイアウトがABIに依存する場合があるため必要である。</p><p>offsetsはoutパラメータである。 呼び出し側は、すべての結果を書き込むのに十分なスペース（struct_typeの各要素型につき1要素）を提供する責任を負う。 offsetsがNULLの場合、型はレイアウトされるが、それ以外は変更されない。 これは、前述のように型のサイズやレイアウトにアクセスするのに便利である。</p><p>abi が無効な場合は FFI_BAD_ABI、 struct_type が何らかの方法で無効な場合は FFI_BAD_TYPEDEF を返す。 ここではFFI_STRUCT型のみが有効であることに注意。</p><h3 id="配列-ユニオン-列挙型" tabindex="-1">配列 ユニオン 列挙型 <a class="header-anchor" href="#配列-ユニオン-列挙型" aria-label="Permalink to &quot;配列 ユニオン 列挙型&quot;">​</a></h3><h4 id="arrays" tabindex="-1">Arrays <a class="header-anchor" href="#arrays" aria-label="Permalink to &quot;Arrays&quot;">​</a></h4><p>libffiは配列やユニオンを直接サポートしていない。しかし、これらは構造体を使用してエミュレートすることができます。</p><p>配列をエミュレートするには、単に FFI_TYPE_STRUCT を使って、配列の要素と同じ数のメンバを持つ ffi_type を作成します。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ffi_type array_type;</span></span>
<span class="line"><span style="color:#E1E4E8;">ffi_type </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">elements</span></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">elements </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">malloc</span><span style="color:#E1E4E8;"> ((n </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">sizeof</span><span style="color:#E1E4E8;"> (ffi_type </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">));</span></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> n; </span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">i)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">elements</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> array_element_type;</span></span>
<span class="line"><span style="color:#FFAB70;">elements</span><span style="color:#E1E4E8;">[n] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">array_type.size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> array_type.alignment </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">array_type.type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> FFI_TYPE_STRUCT;</span></span>
<span class="line"><span style="color:#E1E4E8;">array_type.elements </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> elements;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ffi_type array_type;</span></span>
<span class="line"><span style="color:#24292E;">ffi_type </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">elements</span></span>
<span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">elements </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">malloc</span><span style="color:#24292E;"> ((n </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">sizeof</span><span style="color:#24292E;"> (ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">));</span></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> n; </span><span style="color:#D73A49;">++</span><span style="color:#24292E;">i)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">elements</span><span style="color:#24292E;">[i] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> array_element_type;</span></span>
<span class="line"><span style="color:#E36209;">elements</span><span style="color:#24292E;">[n] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">array_type.size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> array_type.alignment </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">array_type.type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> FFI_TYPE_STRUCT;</span></span>
<span class="line"><span style="color:#24292E;">array_type.elements </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> elements;</span></span></code></pre></div><p>このように作成された構造体型は、実際のFFI_TYPE_STRUCTオブジェクトのメンバを参照するためにのみ使用されるべきである。</p><p>しかし、このようなニセの配列型を引数や戻り値の型として使用しても、libffiがエラーを起こすことはありません。 これは混乱を招くかもしれません。</p><h4 id="unions" tabindex="-1">Unions <a class="header-anchor" href="#unions" aria-label="Permalink to &quot;Unions&quot;">​</a></h4><p>ユニオンはFFI_TYPE_STRUCTを使ってエミュレートすることもできる。 しかしこの場合、サイズとアライメントがユニオンの実際の要求と一致するようにしなければなりません。</p><p>これを行う1つの簡単な方法は、各要素型がレイアウトされていることを確認することです。 それから、新しい構造体タイプに1つの要素、最大の要素のサイズ、同様に見られる最大のアライメントを与える。</p><p>この例では、ffi_prep_cifのトリックを使って、各要素型がレイアウトされていることを確認している。</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ffi_abi desired_abi;</span></span>
<span class="line"><span style="color:#E1E4E8;">ffi_type union_type;</span></span>
<span class="line"><span style="color:#E1E4E8;">ffi_type </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">union_elements;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i;</span></span>
<span class="line"><span style="color:#E1E4E8;">ffi_type </span><span style="color:#FFAB70;">element_types</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFAB70;">element_types</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">union_type.size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> union_type.alignment </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">union_type.type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> FFI_TYPE_STRUCT;</span></span>
<span class="line"><span style="color:#E1E4E8;">union_type.elements </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> element_types;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; </span><span style="color:#FFAB70;">union_elements</span><span style="color:#E1E4E8;">[i]; </span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">i)</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    ffi_cif cif;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ffi_prep_cif</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cif, desired_abi, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">union_elements</span><span style="color:#E1E4E8;">[i], </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> FFI_OK)</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">union_elements</span><span style="color:#E1E4E8;">[i]-&gt;size </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> union_type.size)</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span></span>
<span class="line"><span style="color:#E1E4E8;">            union_type.size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">union_elements</span><span style="color:#E1E4E8;">[i];</span></span>
<span class="line"><span style="color:#E1E4E8;">            size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">union_elements</span><span style="color:#E1E4E8;">[i]-&gt;size;</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#FFAB70;">union_elements</span><span style="color:#E1E4E8;">[i]-&gt;alignment </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> union_type.alignment)</span></span>
<span class="line"><span style="color:#E1E4E8;">          union_type.alignment </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">union_elements</span><span style="color:#E1E4E8;">[i]-&gt;alignment;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ffi_abi desired_abi;</span></span>
<span class="line"><span style="color:#24292E;">ffi_type union_type;</span></span>
<span class="line"><span style="color:#24292E;">ffi_type </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">union_elements;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i;</span></span>
<span class="line"><span style="color:#24292E;">ffi_type </span><span style="color:#E36209;">element_types</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E36209;">element_types</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">union_type.size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> union_type.alignment </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">union_type.type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> FFI_TYPE_STRUCT;</span></span>
<span class="line"><span style="color:#24292E;">union_type.elements </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> element_types;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; </span><span style="color:#E36209;">union_elements</span><span style="color:#24292E;">[i]; </span><span style="color:#D73A49;">++</span><span style="color:#24292E;">i)</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    ffi_cif cif;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ffi_prep_cif</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cif, desired_abi, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#E36209;">union_elements</span><span style="color:#24292E;">[i], </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> FFI_OK)</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">union_elements</span><span style="color:#24292E;">[i]-&gt;size </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> union_type.size)</span></span>
<span class="line"><span style="color:#24292E;">        {</span></span>
<span class="line"><span style="color:#24292E;">            union_type.size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#E36209;">union_elements</span><span style="color:#24292E;">[i];</span></span>
<span class="line"><span style="color:#24292E;">            size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#E36209;">union_elements</span><span style="color:#24292E;">[i]-&gt;size;</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">union_elements</span><span style="color:#24292E;">[i]-&gt;alignment </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> union_type.alignment)</span></span>
<span class="line"><span style="color:#24292E;">          union_type.alignment </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#E36209;">union_elements</span><span style="color:#24292E;">[i]-&gt;alignment;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="列挙体" tabindex="-1">列挙体 <a class="header-anchor" href="#列挙体" aria-label="Permalink to &quot;列挙体&quot;">​</a></h4><p>libffi は C の列挙型を特別にサポートしていません。どの列挙型も特定の基礎となる積分型を使用して実装されていますが、どの型が使用されるかは libffi では正確に決定できません -- 列挙型の値や、-fshort-enums などのコンパイラフラグに依存する場合があります。GCCが列挙型をどのように扱うかについての詳細は、構造体の列挙型とビットフィールドの実装, , , gccを参照してください。</p><h3 id="タイプ例" tabindex="-1">タイプ例 <a class="header-anchor" href="#タイプ例" aria-label="Permalink to &quot;タイプ例&quot;">​</a></h3><p>次の例では、Linuxのtime.hのtm構造体を表すffi_typeオブジェクトを初期化している。</p><p>以下は、構造体の定義方法である：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> tm {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_sec;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_min;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_hour;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_mday;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_mon;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_year;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_wday;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_yday;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> tm_isdst;</span></span>
<span class="line"><span style="color:#6A737D;">    /* Those are for future use. */</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> __tm_gmtoff__;</span></span>
<span class="line"><span style="color:#E1E4E8;">    __const </span><span style="color:#F97583;">char</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">__tm_zone__;</span></span>
<span class="line"><span style="color:#E1E4E8;">};</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> tm {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_sec;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_min;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_hour;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_mday;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_mon;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_year;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_wday;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_yday;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> tm_isdst;</span></span>
<span class="line"><span style="color:#6A737D;">    /* Those are for future use. */</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> __tm_gmtoff__;</span></span>
<span class="line"><span style="color:#24292E;">    __const </span><span style="color:#D73A49;">char</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">__tm_zone__;</span></span>
<span class="line"><span style="color:#24292E;">};</span></span></code></pre></div><p>以下は、この構造体をlibffiに記述するための対応するコードである：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">      ffi_type tm_type;</span></span>
<span class="line"><span style="color:#E1E4E8;">      ffi_type </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">tm_type_elements</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      tm_type.size </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tm_type.alignment </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">      tm_type.type </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> FFI_TYPE_STRUCT;</span></span>
<span class="line"><span style="color:#E1E4E8;">      tm_type.elements </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">tm_type_elements;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> (i </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">; i</span><span style="color:#F97583;">++</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#FFAB70;">tm_type_elements</span><span style="color:#E1E4E8;">[i] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_sint;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#FFAB70;">tm_type_elements</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">9</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_slong;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#FFAB70;">tm_type_elements</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">10</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_pointer;</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#FFAB70;">tm_type_elements</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">11</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">      /* tm_type can now be used to represent tm argument types and</span></span>
<span class="line"><span style="color:#6A737D;">	 return types for ffi_prep_cif() */</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">      ffi_type tm_type;</span></span>
<span class="line"><span style="color:#24292E;">      ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">tm_type_elements</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">12</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> i;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      tm_type.size </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> tm_type.alignment </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">      tm_type.type </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> FFI_TYPE_STRUCT;</span></span>
<span class="line"><span style="color:#24292E;">      tm_type.elements </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">tm_type_elements;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> (i </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9</span><span style="color:#24292E;">; i</span><span style="color:#D73A49;">++</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#E36209;">tm_type_elements</span><span style="color:#24292E;">[i] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_sint;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">tm_type_elements</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">9</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_slong;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">tm_type_elements</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">10</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_pointer;</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">tm_type_elements</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">11</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">      /* tm_type can now be used to represent tm argument types and</span></span>
<span class="line"><span style="color:#6A737D;">	 return types for ffi_prep_cif() */</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span></code></pre></div><h3 id="complex-types" tabindex="-1">Complex Types <a class="header-anchor" href="#complex-types" aria-label="Permalink to &quot;Complex Types&quot;">​</a></h3><p>libffi は、組み込み型記述子 ffi_type_complex_float、 ffi_type_complex_double、 ffi_type_complex_longdouble を使って、 C99 標準 _Complex float、 _Complex double、 _Complex long double で定義された複素数型をサポートしています。</p><p>_Complex intのようなカスタムの複合型も使えます。libffi に複合型を記述するために、ffi_type オブジェクトを定義する必要があります。</p><table><thead><tr><th>メンバ</th><th>説明</th></tr></thead><tbody><tr><td>size_t size</td><td>This must be manually set to the size of the complex type.</td></tr><tr><td>unsigned short alignment</td><td>This must be manually set to the alignment of the complex type.</td></tr><tr><td>unsigned short type</td><td>For a complex type, this must be set to FFI_TYPE_COMPLEX.</td></tr><tr><td>ffi_type **elements</td><td>This is a NULL-terminated array of pointers to ffi_type objects. The first element is set to the ffi_type of the complex&#39;s base type. The second element must be set to NULL.</td></tr></tbody></table><p>複素数の例のセクションでは、プラットフォームに依存しない方法でサイズとアライメントメンバーを決定する方法を示している。</p><p>libffiにまだ複素数のサポートがないプラットフォームでは、関数ffi_prep_cifとffi_prep_argsは複素数型に遭遇するとプログラムを中断します。</p><h3 id="complex-type-example" tabindex="-1">Complex Type Example <a class="header-anchor" href="#complex-type-example" aria-label="Permalink to &quot;Complex Type Example&quot;">​</a></h3><p>This example demonstrates how to use complex types:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;stdio.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;ffi.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;complex.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">complex_fn</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">_Complex</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">cf</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">_Complex</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">cd</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">_Complex</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">cld</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;cf=</span><span style="color:#79B8FF;">%f</span><span style="color:#9ECBFF;">+</span><span style="color:#79B8FF;">%f</span><span style="color:#9ECBFF;">i</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">cd=</span><span style="color:#79B8FF;">%f</span><span style="color:#9ECBFF;">+</span><span style="color:#79B8FF;">%f</span><span style="color:#9ECBFF;">i</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">cld=</span><span style="color:#79B8FF;">%f</span><span style="color:#9ECBFF;">+</span><span style="color:#79B8FF;">%f</span><span style="color:#9ECBFF;">i</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">         (</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">)</span><span style="color:#B392F0;">creal</span><span style="color:#E1E4E8;"> (cf), (</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">)</span><span style="color:#B392F0;">cimag</span><span style="color:#E1E4E8;"> (cf),</span></span>
<span class="line"><span style="color:#E1E4E8;">         (</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">)</span><span style="color:#B392F0;">creal</span><span style="color:#E1E4E8;"> (cd), (</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">)</span><span style="color:#B392F0;">cimag</span><span style="color:#E1E4E8;"> (cd),</span></span>
<span class="line"><span style="color:#E1E4E8;">         (</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">)</span><span style="color:#B392F0;">creal</span><span style="color:#E1E4E8;"> (cld), (</span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;">)</span><span style="color:#B392F0;">cimag</span><span style="color:#E1E4E8;"> (cld));</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_cif cif;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_type </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">values</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">_Complex</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">float</span><span style="color:#E1E4E8;"> cf;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">_Complex</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> cd;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">_Complex</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">double</span><span style="color:#E1E4E8;"> cld;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Initialize the argument info vectors */</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_complex_float;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_complex_double;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_complex_longdouble;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">values</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cf;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">values</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cd;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">values</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cld;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Initialize the cif */</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ffi_prep_cif</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cif, FFI_DEFAULT_ABI, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                   </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_void, args) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> FFI_OK)</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#E1E4E8;">      cf </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">20.0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> I;</span></span>
<span class="line"><span style="color:#E1E4E8;">      cd </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">300.0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">4000.0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> I;</span></span>
<span class="line"><span style="color:#E1E4E8;">      cld </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">50000.0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">600000.0</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> I;</span></span>
<span class="line"><span style="color:#6A737D;">      /* Call the function */</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#B392F0;">ffi_call</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cif, (</span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)(</span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;">))complex_fn, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, values);</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;stdio.h&gt;</span></span>
<span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;ffi.h&gt;</span></span>
<span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;complex.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">complex_fn</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">_Complex</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">float</span><span style="color:#24292E;"> </span><span style="color:#E36209;">cf</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">_Complex</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#E36209;">cd</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                </span><span style="color:#D73A49;">_Complex</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> </span><span style="color:#E36209;">cld</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;cf=</span><span style="color:#005CC5;">%f</span><span style="color:#032F62;">+</span><span style="color:#005CC5;">%f</span><span style="color:#032F62;">i</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">cd=</span><span style="color:#005CC5;">%f</span><span style="color:#032F62;">+</span><span style="color:#005CC5;">%f</span><span style="color:#032F62;">i</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">cld=</span><span style="color:#005CC5;">%f</span><span style="color:#032F62;">+</span><span style="color:#005CC5;">%f</span><span style="color:#032F62;">i</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">         (</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">)</span><span style="color:#6F42C1;">creal</span><span style="color:#24292E;"> (cf), (</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">)</span><span style="color:#6F42C1;">cimag</span><span style="color:#24292E;"> (cf),</span></span>
<span class="line"><span style="color:#24292E;">         (</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">)</span><span style="color:#6F42C1;">creal</span><span style="color:#24292E;"> (cd), (</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">)</span><span style="color:#6F42C1;">cimag</span><span style="color:#24292E;"> (cd),</span></span>
<span class="line"><span style="color:#24292E;">         (</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">)</span><span style="color:#6F42C1;">creal</span><span style="color:#24292E;"> (cld), (</span><span style="color:#D73A49;">float</span><span style="color:#24292E;">)</span><span style="color:#6F42C1;">cimag</span><span style="color:#24292E;"> (cld));</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  ffi_cif cif;</span></span>
<span class="line"><span style="color:#24292E;">  ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">values</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">3</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">_Complex</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">float</span><span style="color:#24292E;"> cf;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">_Complex</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> cd;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">_Complex</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">double</span><span style="color:#24292E;"> cld;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Initialize the argument info vectors */</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_complex_float;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_complex_double;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_complex_longdouble;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">values</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cf;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">values</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cd;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">values</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cld;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Initialize the cif */</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ffi_prep_cif</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cif, FFI_DEFAULT_ABI, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                   </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_void, args) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> FFI_OK)</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#24292E;">      cf </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">20.0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> I;</span></span>
<span class="line"><span style="color:#24292E;">      cd </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">300.0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">4000.0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> I;</span></span>
<span class="line"><span style="color:#24292E;">      cld </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">50000.0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">600000.0</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;"> I;</span></span>
<span class="line"><span style="color:#6A737D;">      /* Call the function */</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#6F42C1;">ffi_call</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cif, (</span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)(</span><span style="color:#D73A49;">void</span><span style="color:#24292E;">))complex_fn, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, values);</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>This is an example for defining a custom complex type descriptor for compilers that support them:</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">/*</span></span>
<span class="line"><span style="color:#6A737D;"> * This macro can be used to define new complex type descriptors</span></span>
<span class="line"><span style="color:#6A737D;"> * in a platform independent way.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * name: Name of the new descriptor is ffi_type_complex_&lt;name&gt;.</span></span>
<span class="line"><span style="color:#6A737D;"> * type: The C base type of the complex type.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#F97583;">#define</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">FFI_COMPLEX_TYPEDEF</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">name</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">type</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">ffitype</span><span style="color:#E1E4E8;">)             </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">static</span><span style="color:#E1E4E8;"> ffi_type </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">ffi_elements_complex_##name [</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {      </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    (ffi_type </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffitype), </span><span style="color:#79B8FF;">NULL</span><span style="color:#E1E4E8;">                             </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  };                                                        </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> struct_align_complex_##name {                      </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">char</span><span style="color:#E1E4E8;"> c;                                                  </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">_Complex</span><span style="color:#E1E4E8;"> type x;                                         </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  };                                                        </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_type ffi_type_complex_##name </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {                      </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">sizeof</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">_Complex</span><span style="color:#E1E4E8;"> type),                                   </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">offsetof</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> struct_align_complex_##name, x),         </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    FFI_TYPE_COMPLEX,                                        </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    (ffi_type </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">)ffi_elements_complex_##name                 </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/* Define new complex type descriptors using the macro: */</span></span>
<span class="line"><span style="color:#6A737D;">/* ffi_type_complex_sint */</span></span>
<span class="line"><span style="color:#B392F0;">FFI_COMPLEX_TYPEDEF</span><span style="color:#E1E4E8;">(sint, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">, ffi_type_sint);</span></span>
<span class="line"><span style="color:#6A737D;">/* ffi_type_complex_uchar */</span></span>
<span class="line"><span style="color:#B392F0;">FFI_COMPLEX_TYPEDEF</span><span style="color:#E1E4E8;">(uchar, </span><span style="color:#F97583;">unsigned</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">char</span><span style="color:#E1E4E8;">, ffi_type_uint8);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">/*</span></span>
<span class="line"><span style="color:#6A737D;"> * This macro can be used to define new complex type descriptors</span></span>
<span class="line"><span style="color:#6A737D;"> * in a platform independent way.</span></span>
<span class="line"><span style="color:#6A737D;"> *</span></span>
<span class="line"><span style="color:#6A737D;"> * name: Name of the new descriptor is ffi_type_complex_&lt;name&gt;.</span></span>
<span class="line"><span style="color:#6A737D;"> * type: The C base type of the complex type.</span></span>
<span class="line"><span style="color:#6A737D;"> */</span></span>
<span class="line"><span style="color:#D73A49;">#define</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">FFI_COMPLEX_TYPEDEF</span><span style="color:#24292E;">(</span><span style="color:#E36209;">name</span><span style="color:#24292E;">, </span><span style="color:#E36209;">type</span><span style="color:#24292E;">, </span><span style="color:#E36209;">ffitype</span><span style="color:#24292E;">)             </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">static</span><span style="color:#24292E;"> ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">ffi_elements_complex_##name [</span><span style="color:#005CC5;">2</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {      </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    (ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffitype), </span><span style="color:#005CC5;">NULL</span><span style="color:#24292E;">                             </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  };                                                        </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> struct_align_complex_##name {                      </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">char</span><span style="color:#24292E;"> c;                                                  </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">_Complex</span><span style="color:#24292E;"> type x;                                         </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  };                                                        </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  ffi_type ffi_type_complex_##name </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {                      </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">sizeof</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">_Complex</span><span style="color:#24292E;"> type),                                   </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">offsetof</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> struct_align_complex_##name, x),         </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    FFI_TYPE_COMPLEX,                                        </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    (ffi_type </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">)ffi_elements_complex_##name                 </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/* Define new complex type descriptors using the macro: */</span></span>
<span class="line"><span style="color:#6A737D;">/* ffi_type_complex_sint */</span></span>
<span class="line"><span style="color:#6F42C1;">FFI_COMPLEX_TYPEDEF</span><span style="color:#24292E;">(sint, </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">, ffi_type_sint);</span></span>
<span class="line"><span style="color:#6A737D;">/* ffi_type_complex_uchar */</span></span>
<span class="line"><span style="color:#6F42C1;">FFI_COMPLEX_TYPEDEF</span><span style="color:#24292E;">(uchar, </span><span style="color:#D73A49;">unsigned</span><span style="color:#24292E;"> </span><span style="color:#E36209;">char</span><span style="color:#24292E;">, ffi_type_uint8);</span></span></code></pre></div><p>The new type descriptors can then be used like one of the built-in type descriptors in the previous example.</p><h3 id="multiple-abis" tabindex="-1">Multiple ABIs <a class="header-anchor" href="#multiple-abis" aria-label="Permalink to &quot;Multiple ABIs&quot;">​</a></h3><p>A given platform may provide multiple different ABIs at once. For instance, the x86 platform has both stdcall and fastcall functions.</p><p>libffi provides some support for this. However, this is necessarily platform-specific.</p><h3 id="the-closure-api" tabindex="-1">The Closure API <a class="header-anchor" href="#the-closure-api" aria-label="Permalink to &quot;The Closure API&quot;">​</a></h3><p>libffiは汎用関数を書く方法も提供している。任意の引数の組み合わせを受け入れ、デコードできる関数。これはインタープリターを書くときや、任意の関数のラッパーを提供するときに便利だ。</p><p>この機能はクロージャAPIと呼ばれる。クロージャはすべてのプラットフォームでサポートされているわけではありません。現在のプラットフォームでサポートされているかどうかは、FFI_CLOSURES定義で確認できます。</p><p>クロージャは実行時に小さな関数をアセンブルすることで動作するため、実行不可能なヒープを持つプラットフォームでは特別な割り当てが必要になる。 クロージャのメモリー管理は、2つの関数によって処理される：</p><h4 id="ffi-closure-alloc" tabindex="-1"><code>ffi_closure_alloc()</code> <a class="header-anchor" href="#ffi-closure-alloc" aria-label="Permalink to &quot;\`ffi_closure_alloc()\`&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#B392F0;">ffi_closure_alloc</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">size_t</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">size</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">**</span><span style="color:#FFAB70;">code</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#6F42C1;">ffi_closure_alloc</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">size_t</span><span style="color:#24292E;"> </span><span style="color:#E36209;">size</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">**</span><span style="color:#E36209;">code</span><span style="color:#24292E;">)</span></span></code></pre></div><p>サイズ・バイトのメモリチャンクを確保する。 これは書き込み可能なアドレスへのポインタを返し、*codeを対応する実行可能アドレスに設定する。</p><p>sizeはffi_closureオブジェクトを保持するのに十分でなければならない。</p><h4 id="ffi-closure-free" tabindex="-1"><code>ffi_closure_free()</code> <a class="header-anchor" href="#ffi-closure-free" aria-label="Permalink to &quot;\`ffi_closure_free()\`&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ffi_closure_free</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">writable</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ffi_closure_free</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">writable</span><span style="color:#24292E;">)</span></span></code></pre></div><p>ffi_closure_alloc を使って割り当てられたメモリーを解放する。 引数は返された書き込み可能なアドレスである。</p><p>Once you have allocated the memory for a closure, you must construct a ffi_cif describing the function call. Finally you can prepare the closure function:</p><h4 id="ffi-prep-closure-loc" tabindex="-1"><code>ffi_prep_closure_loc()</code> <a class="header-anchor" href="#ffi-prep-closure-loc" aria-label="Permalink to &quot;\`ffi_prep_closure_loc()\`&quot;">​</a></h4><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ffi_status </span><span style="color:#B392F0;">ffi_prep_closure_loc</span><span style="color:#E1E4E8;"> (ffi_closure </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">closure</span><span style="color:#E1E4E8;">, ffi_cif </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">cif</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">fun) (ffi_cif </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">cif, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">ret, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">args, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">user_data), </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">user_data</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">codeloc</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ffi_status </span><span style="color:#6F42C1;">ffi_prep_closure_loc</span><span style="color:#24292E;"> (ffi_closure </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">closure</span><span style="color:#24292E;">, ffi_cif </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">cif</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">fun) (ffi_cif </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">cif, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">ret, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">args, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">user_data), </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">user_data</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">codeloc</span><span style="color:#24292E;">)</span></span></code></pre></div><p>クロージャー関数を準備する。 ffi_prep_closure_locの引数は以下の通り：</p><table><thead><tr><th>引数名</th><th>説明</th></tr></thead><tbody><tr><td>closure</td><td>The address of a ffi_closure object; this is the writable address returned by ffi_closure_alloc.</td></tr><tr><td>cif</td><td>The ffi_cif describing the function parameters. Note that this object, and the types to which it refers, must be kept alive until the closure itself is freed.</td></tr><tr><td>user_data</td><td>An arbitrary datum that is passed, uninterpreted, to your closure function.</td></tr><tr><td>codeloc</td><td>The executable address returned by ffi_closure_alloc.</td></tr><tr><td>fun</td><td>The function which will be called when the closure is invoked. It is called with the arguments:</td></tr><tr><td>cif</td><td>The ffi_cif passed to ffi_prep_closure_loc.</td></tr><tr><td>ret</td><td>A pointer to the memory used for the function&#39;s return value. If the function is declared as returning void, then this value is garbage and should not be used. Otherwise, fun must fill the object to which this points, following the same special promotion behavior as ffi_call. That is, in most cases, ret points to an object of exactly the size of the type specified when cif was constructed. However, integral types narrower than the system register size are widened. In these cases your program may assume that ret points to an ffi_arg object.</td></tr><tr><td>args</td><td>A vector of pointers to memory holding the arguments to the function.</td></tr><tr><td>user_data</td><td>The same user_data that was passed to ffi_prep_closure_loc.</td></tr></tbody></table><p>ffi_prep_closure_loc will return FFI_OK if everything went ok, and one of the other ffi_status values on error.</p><p>After calling ffi_prep_closure_loc, you can cast codeloc to the appropriate pointer-to-function type.</p><p>You may see old code referring to ffi_prep_closure. This function is deprecated, as it cannot handle the need for separate writable and executable addresses.</p><h3 id="closure-example" tabindex="-1">Closure Example <a class="header-anchor" href="#closure-example" aria-label="Permalink to &quot;Closure Example&quot;">​</a></h3><p>A trivial example that creates a new puts by binding fputs with stdout.</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;stdio.h&gt;</span></span>
<span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;ffi.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/* Acts like puts with the file given at time of enclosure. */</span></span>
<span class="line"><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">puts_binding</span><span style="color:#E1E4E8;">(ffi_cif </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">cif</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">ret</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">void*</span><span style="color:#E1E4E8;"> </span><span style="color:#FFAB70;">args</span><span style="color:#F97583;">[]</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">stream</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(ffi_arg </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)ret </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fputs</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">char</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">**</span><span style="color:#E1E4E8;">)</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], (FILE </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">)stream);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">typedef</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">*</span><span style="color:#79B8FF;">puts_t</span><span style="color:#E1E4E8;">)(</span><span style="color:#F97583;">char</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_cif cif;</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_type </span><span style="color:#F97583;">*</span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">];</span></span>
<span class="line"><span style="color:#E1E4E8;">  ffi_closure </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">closure;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">void</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">bound_puts;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> rc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Allocate closure and bound_puts */</span></span>
<span class="line"><span style="color:#E1E4E8;">  closure </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ffi_closure_alloc</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">sizeof</span><span style="color:#E1E4E8;">(ffi_closure), </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">bound_puts);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (closure)</span></span>
<span class="line"><span style="color:#E1E4E8;">    {</span></span>
<span class="line"><span style="color:#6A737D;">      /* Initialize the argument info vectors */</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#FFAB70;">args</span><span style="color:#E1E4E8;">[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_pointer;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">      /* Initialize the cif */</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ffi_prep_cif</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cif, FFI_DEFAULT_ABI, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">ffi_type_sint, args) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> FFI_OK)</span></span>
<span class="line"><span style="color:#E1E4E8;">        {</span></span>
<span class="line"><span style="color:#6A737D;">          /* Initialize the closure, setting stream to stdout */</span></span>
<span class="line"><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#B392F0;">ffi_prep_closure_loc</span><span style="color:#E1E4E8;">(closure, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">cif, puts_binding,</span></span>
<span class="line"><span style="color:#E1E4E8;">                                   stdout, bound_puts) </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> FFI_OK)</span></span>
<span class="line"><span style="color:#E1E4E8;">            {</span></span>
<span class="line"><span style="color:#E1E4E8;">              rc </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> ((</span><span style="color:#79B8FF;">puts_t</span><span style="color:#E1E4E8;">)bound_puts)(</span><span style="color:#9ECBFF;">&quot;Hello World!&quot;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">              /* rc now holds the result of the call to fputs */</span></span>
<span class="line"><span style="color:#E1E4E8;">            }</span></span>
<span class="line"><span style="color:#E1E4E8;">        }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Deallocate both closure, and bound_puts */</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">ffi_closure_free</span><span style="color:#E1E4E8;">(closure);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;stdio.h&gt;</span></span>
<span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;ffi.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">/* Acts like puts with the file given at time of enclosure. */</span></span>
<span class="line"><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">puts_binding</span><span style="color:#24292E;">(ffi_cif </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">cif</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">ret</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">void*</span><span style="color:#24292E;"> </span><span style="color:#E36209;">args</span><span style="color:#D73A49;">[]</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">stream</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(ffi_arg </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)ret </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fputs</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">char</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">**</span><span style="color:#24292E;">)</span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], (FILE </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">)stream);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">typedef</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">*</span><span style="color:#005CC5;">puts_t</span><span style="color:#24292E;">)(</span><span style="color:#D73A49;">char</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  ffi_cif cif;</span></span>
<span class="line"><span style="color:#24292E;">  ffi_type </span><span style="color:#D73A49;">*</span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">];</span></span>
<span class="line"><span style="color:#24292E;">  ffi_closure </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">closure;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">void</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">bound_puts;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> rc;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Allocate closure and bound_puts */</span></span>
<span class="line"><span style="color:#24292E;">  closure </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ffi_closure_alloc</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">sizeof</span><span style="color:#24292E;">(ffi_closure), </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">bound_puts);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (closure)</span></span>
<span class="line"><span style="color:#24292E;">    {</span></span>
<span class="line"><span style="color:#6A737D;">      /* Initialize the argument info vectors */</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#E36209;">args</span><span style="color:#24292E;">[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_pointer;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">      /* Initialize the cif */</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ffi_prep_cif</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cif, FFI_DEFAULT_ABI, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">                       </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">ffi_type_sint, args) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> FFI_OK)</span></span>
<span class="line"><span style="color:#24292E;">        {</span></span>
<span class="line"><span style="color:#6A737D;">          /* Initialize the closure, setting stream to stdout */</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#6F42C1;">ffi_prep_closure_loc</span><span style="color:#24292E;">(closure, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">cif, puts_binding,</span></span>
<span class="line"><span style="color:#24292E;">                                   stdout, bound_puts) </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> FFI_OK)</span></span>
<span class="line"><span style="color:#24292E;">            {</span></span>
<span class="line"><span style="color:#24292E;">              rc </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> ((</span><span style="color:#005CC5;">puts_t</span><span style="color:#24292E;">)bound_puts)(</span><span style="color:#032F62;">&quot;Hello World!&quot;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">              /* rc now holds the result of the call to fputs */</span></span>
<span class="line"><span style="color:#24292E;">            }</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">  /* Deallocate both closure, and bound_puts */</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">ffi_closure_free</span><span style="color:#24292E;">(closure);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="thread-safety" tabindex="-1">Thread Safety <a class="header-anchor" href="#thread-safety" aria-label="Permalink to &quot;Thread Safety&quot;">​</a></h3><p>libffi is not completely thread-safe. However, many parts are, and if you follow some simple rules, you can use it safely in a multi-threaded program.</p><p>ffi_prep_cif may modify the ffi_type objects passed to it. It is best to ensure that only a single thread prepares a given ffi_cif at a time.</p><p>On some platforms, ffi_prep_cif may modify the size and alignment of some types, depending on the chosen ABI. On these platforms, if you switch between ABIs, you must ensure that there is only one call to ffi_prep_cif at a time.</p><p>Currently the only affected platform is PowerPC and the only affected type is long double.</p><h3 id="memory-usage" tabindex="-1">Memory Usage <a class="header-anchor" href="#memory-usage" aria-label="Permalink to &quot;Memory Usage&quot;">​</a></h3><p>Note that memory allocated by ffi_closure_alloc and freed by ffi_closure_free does not come from the same general pool of memory that malloc and free use. To accomodate security settings, libffi may aquire memory, for example, by mapping temporary files into multiple places in the address space (once to write out the closure, a second to execute it). The search follows this list, using the first that works:</p><ul><li>A anonymous mapping (i.e. not file-backed)</li><li>memfd_create(), if the kernel supports it.</li><li>A file created in the directory referenced by the environment variable LIBFFI_TMPDIR.</li><li>Likewise for the environment variable TMPDIR.</li><li>A file created in /tmp.</li><li>A file created in /var/tmp.</li><li>A file created in /dev/shm.</li><li>A file created in the user&#39;s home directory ($HOME).</li><li>A file created in any directory listed in /etc/mtab.</li><li>A file created in any directory listed in @code{/proc/mounts}.</li></ul><p>If security settings prohibit using any of these for closures, ffi_closure_alloc will fail.</p><h3 id="missing-features" tabindex="-1">Missing Features <a class="header-anchor" href="#missing-features" aria-label="Permalink to &quot;Missing Features&quot;">​</a></h3><p>libffi is missing a few features. We welcome patches to add support for these.</p><ul><li>Variadic closures.</li><li>There is no support for bit fields in structures.</li><li>The raw API is undocumented.</li><li>The Go API is undocumented.</li></ul>`,135),e=[o];function t(c,r,y,E,i,f){return n(),a("div",null,e)}const _=s(p,[["render",t]]);export{F as __pageData,_ as default};
