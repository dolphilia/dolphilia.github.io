import{_ as s,o as a,c as n,Q as p}from"./chunks/framework.43c433ff.js";const d=JSON.parse('{"title":"BMP以外の文字を扱う方法","description":"","frontmatter":{},"headers":[],"relativePath":"translation/duktape/wiki/how_to_work_with_non-bmp_characters.md","filePath":"translation/duktape/wiki/how_to_work_with_non-bmp_characters.md","lastUpdated":1676126774000}'),l={name:"translation/duktape/wiki/how_to_work_with_non-bmp_characters.md"},o=p(`<h1 id="bmp以外の文字を扱う方法" tabindex="-1">BMP以外の文字を扱う方法 <a class="header-anchor" href="#bmp以外の文字を扱う方法" aria-label="Permalink to &quot;BMP以外の文字を扱う方法&quot;">​</a></h1><h2 id="ecmascript-と-duktape-による非-bmp-のサポート" tabindex="-1">ECMAScript と Duktape による非 BMP のサポート <a class="header-anchor" href="#ecmascript-と-duktape-による非-bmp-のサポート" aria-label="Permalink to &quot;ECMAScript と Duktape による非 BMP のサポート&quot;">​</a></h2><h3 id="ecmascript-の標準文字列は-16-ビットのみ" tabindex="-1">ECMAScript の標準文字列は 16 ビットのみ <a class="header-anchor" href="#ecmascript-の標準文字列は-16-ビットのみ" aria-label="Permalink to &quot;ECMAScript の標準文字列は 16 ビットのみ&quot;">​</a></h3><p>ECMAScript 標準自体は非 BMP 文字をサポートしていません: すべてのコードポイントは厳密に 16-bit です。非 BMP 文字はサロゲートペアで表現されることを意図しています。</p><ul><li>E5.1 Section 8.4: <a href="http://www.ecma-international.org/ecma-262/5.1/#sec-8.4" target="_blank" rel="noreferrer">http://www.ecma-international.org/ecma-262/5.1/#sec-8.4</a></li><li>E6 Section 6.1.4: <a href="http://www.ecma-international.org/ecma-262/6.0/#sec-ecmascript-language-types-string-type" target="_blank" rel="noreferrer">http://www.ecma-international.org/ecma-262/6.0/#sec-ecmascript-language-types-string-type</a></li></ul><p>ES2015 RegExp の u フラグを持つパターンは、文字列データを UTF-16 として解釈することで、非 BMP 文字をサポートしています。</p><ul><li><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-pattern-semantics" target="_blank" rel="noreferrer">http://www.ecma-international.org/ecma-262/6.0/#sec-pattern-semantics</a></li></ul><p>ES2015 String.prototype.trim()では、非BMP文字に対する特別な処理も行っています（ここでも文字列はUTF-16として解釈されます）。</p><ul><li><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-string.prototype.trim" target="_blank" rel="noreferrer">http://www.ecma-international.org/ecma-262/6.0/#sec-string.prototype.trim</a></li></ul><h3 id="duktape文字列は最大32ビットのコードポイントをサポート" tabindex="-1">Duktape文字列は最大32ビットのコードポイントをサポート <a class="header-anchor" href="#duktape文字列は最大32ビットのコードポイントをサポート" aria-label="Permalink to &quot;Duktape文字列は最大32ビットのコードポイントをサポート&quot;">​</a></h3><p>Duktapeは、拡張UTF-8形式で文字列を表現します。この形式では、任意の16ビット・コードポイント（ECMAScriptが要求するもの）と、完全な32ビット範囲の拡張コードポイントの両方が許容されます。また、（UTF-8では無効な）任意のバイト列も許容されます。</p><ul><li><a href="http://duktape.org/guide.html#type-string" target="_blank" rel="noreferrer">http://duktape.org/guide.html#type-string</a></li></ul><p>その結果、DuktapeはBMP以外の範囲の文字を直接サポートすることになりました。</p><ul><li>Cコードは、例えばduk_push_string()を使って、（拡張）UTF-8として表現された文字列を直接プッシュすることができます。</li><li>非 BMP 文字は、ほとんど ECMAScript コードで期待通りに動作します。標準的なバインディングはコードポイントが最大 16 ビットであることを期待しているので、期待通りに動作しない ECMAScript バインディングがいくつかあります。</li></ul><h2 id="bmp非対応文字への主な対応方法" tabindex="-1">BMP非対応文字への主な対応方法 <a class="header-anchor" href="#bmp非対応文字への主な対応方法" aria-label="Permalink to &quot;BMP非対応文字への主な対応方法&quot;">​</a></h2><p>主にどちらかを選択することになります。</p><ul><li>サロゲートペアの使用：標準的な方法で、エンジンに依存しませんが、文字列の長さがサロゲートペアの文字を個別に数えるなど、いくつかの不都合があります。Cコードでは、非BMP文字をまずサロゲートペアにエンコードし、そのペアの各コードポイントをCESU-8でエンコードします。</li><li>Duktape固有の非BMP文字列を使用する：Cコードにとってより自然で、.lengthは正しくなります。Cコードでは、文字列を直接UTF-8でエンコードします。</li></ul><h2 id="サロゲートペアの使用" tabindex="-1">サロゲートペアの使用 <a class="header-anchor" href="#サロゲートペアの使用" aria-label="Permalink to &quot;サロゲートペアの使用&quot;">​</a></h2><p>例えば、LEFT-POINTING MAGNIFYING GLASS U+1F50Dを表すには、以下のようにします。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// http://www.russellcottrell.com/greek/utilities/surrogatepaircalculator.htm</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> magnifyingGlass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\uD83D\\uDD0D</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(magnifyingGlass.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">);  </span><span style="color:#6A737D;">// prints 2</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(Duktape.</span><span style="color:#B392F0;">enc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">, magnifyingGlass));  </span><span style="color:#6A737D;">// prints eda0bdedb48d, surrogate codepoints eda0bd edb48d</span></span>
<span class="line"><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> eda0bdedb48d</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// http://www.russellcottrell.com/greek/utilities/surrogatepaircalculator.htm</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> magnifyingGlass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">\\uD83D\\uDD0D</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(magnifyingGlass.</span><span style="color:#005CC5;">length</span><span style="color:#24292E;">);  </span><span style="color:#6A737D;">// prints 2</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(Duktape.</span><span style="color:#6F42C1;">enc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;hex&#39;</span><span style="color:#24292E;">, magnifyingGlass));  </span><span style="color:#6A737D;">// prints eda0bdedb48d, surrogate codepoints eda0bd edb48d</span></span>
<span class="line"><span style="color:#D73A49;">=</span><span style="color:#24292E;"> eda0bdedb48d</span></span></code></pre></div><p>特に、&quot;the \\u escape &quot;は4桁までしか受け付けないため、誤解を招く可能性があることに注意してください。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// U+1F50の後にASCIIの&#39;D&#39;が続くとパースされる。</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> magnifyingGlass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">\\u1F50</span><span style="color:#9ECBFF;">D&#39;</span><span style="color:#E1E4E8;">;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// U+1F50の後にASCIIの&#39;D&#39;が続くとパースされる。</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> magnifyingGlass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">\\u1F50</span><span style="color:#032F62;">D&#39;</span><span style="color:#24292E;">;</span></span></code></pre></div><p>もし、あなたのCコードにUTF-8を表示させたいなら、サロゲートペアを適切にエンコード/デコードする必要があります。おそらく、以下のようなヘルパーを書くのがベストでしょう。</p><ul><li>UTF-8文字列を値スタックにプッシュし、非BMP文字をサロゲートペア(CESU-8)に変換する。</li><li>サロゲートペア(CESU-8)をUTF-8に変換して、文字列をスタックに読み込む。</li></ul><h2 id="duktape-utf-8を使用する" tabindex="-1">Duktape UTF-8を使用する <a class="header-anchor" href="#duktape-utf-8を使用する" aria-label="Permalink to &quot;Duktape UTF-8を使用する&quot;">​</a></h2><p>この方法は、文字列を直接UTF-8で表現できるため、変換やサロゲートペアの扱いが不要であり、Cコードに便利です。</p><p>制限としては、非BMP文字に対するECMAScriptの構文がないため、リテラルで使用できないことが挙げられます。いくつかの回避策があります。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// UTF-8に対応したDuktape JXフォーマットからデコードします。</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> magnifyingGlass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Duktape.</span><span style="color:#B392F0;">dec</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;jx&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;&quot;</span><span style="color:#79B8FF;">\\\\</span><span style="color:#9ECBFF;">U0001f50d&quot;&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(magnifyingGlass.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">);  </span><span style="color:#6A737D;">// prints 1</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(Duktape.</span><span style="color:#B392F0;">enc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">, magnifyingGlass));  </span><span style="color:#6A737D;">// prints f09f948d, direct UTF-8  for U+1F50D</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// UTF-8データを16進数で直接入力します。</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> magnifyingGlass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Duktape.</span><span style="color:#B392F0;">dec</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;f09f948d&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(magnifyingGlass.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(Duktape.</span><span style="color:#B392F0;">enc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">, magnifyingGlass));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// UTF-8 データをバッファに入力し、文字列に変換する。</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> magnifyingGlass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">String</span><span style="color:#E1E4E8;">(Duktape.</span><span style="color:#B392F0;">Buffer</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Uint8Array</span><span style="color:#E1E4E8;">([ </span><span style="color:#79B8FF;">0xf0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0x9f</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0x94</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0x8d</span><span style="color:#E1E4E8;"> ])));</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(magnifyingGlass.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(Duktape.</span><span style="color:#B392F0;">enc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">, magnifyingGlass));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Duktape 1.2.0 以降の fromCharCode() は、非 BMP コードポイントを受け入れるためのデフォルトの非標準動作（無効にすることが可能）になっています。</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> magnifyingGlass </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> String.</span><span style="color:#B392F0;">fromCharCode</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0x1f50d</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(magnifyingGlass.</span><span style="color:#79B8FF;">length</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#B392F0;">print</span><span style="color:#E1E4E8;">(Duktape.</span><span style="color:#B392F0;">enc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;hex&#39;</span><span style="color:#E1E4E8;">, magnifyingGlass));</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// UTF-8に対応したDuktape JXフォーマットからデコードします。</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> magnifyingGlass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Duktape.</span><span style="color:#6F42C1;">dec</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;jx&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;&quot;</span><span style="color:#005CC5;">\\\\</span><span style="color:#032F62;">U0001f50d&quot;&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(magnifyingGlass.</span><span style="color:#005CC5;">length</span><span style="color:#24292E;">);  </span><span style="color:#6A737D;">// prints 1</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(Duktape.</span><span style="color:#6F42C1;">enc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;hex&#39;</span><span style="color:#24292E;">, magnifyingGlass));  </span><span style="color:#6A737D;">// prints f09f948d, direct UTF-8  for U+1F50D</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// UTF-8データを16進数で直接入力します。</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> magnifyingGlass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> Duktape.</span><span style="color:#6F42C1;">dec</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;hex&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;f09f948d&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(magnifyingGlass.</span><span style="color:#005CC5;">length</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(Duktape.</span><span style="color:#6F42C1;">enc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;hex&#39;</span><span style="color:#24292E;">, magnifyingGlass));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// UTF-8 データをバッファに入力し、文字列に変換する。</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> magnifyingGlass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">String</span><span style="color:#24292E;">(Duktape.</span><span style="color:#6F42C1;">Buffer</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Uint8Array</span><span style="color:#24292E;">([ </span><span style="color:#005CC5;">0xf0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0x9f</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0x94</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0x8d</span><span style="color:#24292E;"> ])));</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(magnifyingGlass.</span><span style="color:#005CC5;">length</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(Duktape.</span><span style="color:#6F42C1;">enc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;hex&#39;</span><span style="color:#24292E;">, magnifyingGlass));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Duktape 1.2.0 以降の fromCharCode() は、非 BMP コードポイントを受け入れるためのデフォルトの非標準動作（無効にすることが可能）になっています。</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> magnifyingGlass </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> String.</span><span style="color:#6F42C1;">fromCharCode</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0x1f50d</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(magnifyingGlass.</span><span style="color:#005CC5;">length</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6F42C1;">print</span><span style="color:#24292E;">(Duktape.</span><span style="color:#6F42C1;">enc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;hex&#39;</span><span style="color:#24292E;">, magnifyingGlass));</span></span></code></pre></div>`,28),e=[o];function t(r,c,i,y,E,F){return a(),n("div",null,e)}const h=s(l,[["render",t]]);export{d as __pageData,h as default};
