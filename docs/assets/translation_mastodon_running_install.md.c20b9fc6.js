import{_ as s,c as a,o as n,a as l}from"./app.b419af8d.js";const A=JSON.parse('{"title":"ソースからのインストール","description":"","frontmatter":{},"headers":[{"level":2,"title":"前提条件","slug":"前提条件","link":"#前提条件","children":[{"level":3,"title":"システムレポジトリ","slug":"システムレポジトリ","link":"#システムレポジトリ","children":[]},{"level":3,"title":"システムパッケージ","slug":"システムパッケージ","link":"#システムパッケージ","children":[]},{"level":3,"title":"Rubyのインストール","slug":"rubyのインストール","link":"#rubyのインストール","children":[]}]},{"level":2,"title":"セットアップ","slug":"セットアップ","link":"#セットアップ","children":[{"level":3,"title":"PostgreSQLのセットアップ","slug":"postgresqlのセットアップ","link":"#postgresqlのセットアップ","children":[]},{"level":3,"title":"マストドンのセットアップ","slug":"マストドンのセットアップ","link":"#マストドンのセットアップ","children":[]},{"level":3,"title":"nginxのセットアップ","slug":"nginxのセットアップ","link":"#nginxのセットアップ","children":[]},{"level":3,"title":"SSL証明書の取得","slug":"ssl証明書の取得","link":"#ssl証明書の取得","children":[]},{"level":3,"title":"systemd サービスのセットアップ","slug":"systemd-サービスのセットアップ","link":"#systemd-サービスのセットアップ","children":[]}]}],"relativePath":"translation/mastodon/running/install.md","lastUpdated":1676784496000}'),p={name:"translation/mastodon/running/install.md"},e=l(`<h1 id="ソースからのインストール" tabindex="-1">ソースからのインストール <a class="header-anchor" href="#ソースからのインストール" aria-hidden="true">#</a></h1><p>マストドンを利用したウェブサイトを作成するための解説書です。</p><nav class="table-of-contents"><ul><li><a href="#前提条件">前提条件</a><ul><li><a href="#システムレポジトリ">システムレポジトリ</a></li><li><a href="#システムパッケージ">システムパッケージ</a></li><li><a href="#rubyのインストール">Rubyのインストール</a></li></ul></li><li><a href="#セットアップ">セットアップ</a><ul><li><a href="#postgresqlのセットアップ">PostgreSQLのセットアップ</a></li><li><a href="#マストドンのセットアップ">マストドンのセットアップ</a></li><li><a href="#nginxのセットアップ">nginxのセットアップ</a></li><li><a href="#ssl証明書の取得">SSL証明書の取得</a></li><li><a href="#systemd-サービスのセットアップ">systemd サービスのセットアップ</a></li></ul></li></ul></nav><h2 id="前提条件" tabindex="-1">前提条件 <a class="header-anchor" href="#前提条件" aria-hidden="true">#</a></h2><ul><li><strong>Ubuntu 20.04</strong>または<strong>Debian 11</strong>が動作しているマシンで、root権限を持っていること。</li><li>Mastodon サーバーの <strong>ドメイン名</strong> (またはサブドメイン) 例: <code>example.com</code>.</li><li>メール配信サービスなどの <strong>SMTP サーバー</strong> が必要です。</li></ul><p>コマンドは root で実行することになります。root でない場合は、root に切り替えてください。<code>sudo su -</code></p><h3 id="システムレポジトリ" tabindex="-1">システムレポジトリ <a class="header-anchor" href="#システムレポジトリ" aria-hidden="true">#</a></h3><p>curl, wget, gnupg, apt-transport-https, lsb-release, ca-certificates が先にインストールされていることを確認してください。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gnupg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-transport-https</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lsb-release</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ca-certificates</span></span>
<span class="line"></span></code></pre></div><h4 id="node-js" tabindex="-1">Node.js <a class="header-anchor" href="#node-js" aria-hidden="true">#</a></h4><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-sL</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://deb.nodesource.com/setup_16.x</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">bash</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-</span></span>
<span class="line"></span></code></pre></div><h4 id="postgresql" tabindex="-1">PostgreSQL <a class="header-anchor" href="#postgresql" aria-hidden="true">#</a></h4><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-O</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/share/keyrings/postgresql.asc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://www.postgresql.org/media/keys/ACCC4CF8.asc</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">deb [signed-by=/usr/share/keyrings/postgresql.asc] http://apt.postgresql.org/pub/repos/apt </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">lsb_release</span><span style="color:#C3E88D;"> -cs</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">-pgdg main</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/apt/sources.list.d/postgresql.list</span></span>
<span class="line"></span></code></pre></div><h3 id="システムパッケージ" tabindex="-1">システムパッケージ <a class="header-anchor" href="#システムパッケージ" aria-hidden="true">#</a></h3><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">imagemagick</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ffmpeg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libpq-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libxml2-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libxslt1-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">git-core</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">g++</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libprotobuf-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">protobuf-compiler</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pkg-config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nodejs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gcc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">autoconf</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">bison</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build-essential</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libssl-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libyaml-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libreadline6-dev</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">zlib1g-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libncurses5-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libffi-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libgdbm-dev</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">redis-server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">redis-tools</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">postgresql</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">postgresql-contrib</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">certbot</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">python3-certbot-nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libidn11-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libicu-dev</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">libjemalloc-dev</span></span>
<span class="line"></span></code></pre></div><h4 id="yarn" tabindex="-1">Yarn <a class="header-anchor" href="#yarn" aria-hidden="true">#</a></h4><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">corepack</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">enable</span></span>
<span class="line"><span style="color:#FFCB6B;">yarn</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">version</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">classic</span></span>
<span class="line"></span></code></pre></div><h3 id="rubyのインストール" tabindex="-1">Rubyのインストール <a class="header-anchor" href="#rubyのインストール" aria-hidden="true">#</a></h3><p>Rubyのバージョン管理にはrbenvを使います。正しいバージョンを取得し、新しいリリースが出たらアップデートするのが簡単だからです。rbenvは単一のLinuxユーザに対してインストールする必要があるので、まずMastodonが動作するユーザを作成します。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">adduser</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--disabled-login</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mastodon</span></span>
<span class="line"></span></code></pre></div><p>その後、ユーザーに切り替わります。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">su</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mastodon</span></span>
<span class="line"></span></code></pre></div><p>そして、rbenvとrbenv-buildのインストールに進みます。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">clone</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/rbenv/rbenv.git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.rbenv</span></span>
<span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.rbenv</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">src/configure</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-C</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">src</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">export PATH=&quot;$HOME/.rbenv/bin:$PATH&quot;</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.bashrc</span></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">eval &quot;$(rbenv init -)&quot;</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.bashrc</span></span>
<span class="line"><span style="color:#82AAFF;">exec</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bash</span></span>
<span class="line"><span style="color:#FFCB6B;">git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">clone</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/rbenv/ruby-build.git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.rbenv/plugins/ruby-build</span></span>
<span class="line"></span></code></pre></div><p>これが終われば、正しいRubyのバージョンをインストールすることができます。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">RUBY_CONFIGURE_OPTS</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">--with-jemalloc</span><span style="color:#A6ACCD;"> rbenv install 3.0.4</span></span>
<span class="line"><span style="color:#FFCB6B;">rbenv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">global</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">3.0.4</span></span>
<span class="line"></span></code></pre></div><p>また、bundlerのインストールも必要です。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">gem</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bundler</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--no-document</span></span>
<span class="line"></span></code></pre></div><p>ルートユーザーに戻る。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">exit</span></span>
<span class="line"></span></code></pre></div><h2 id="セットアップ" tabindex="-1">セットアップ <a class="header-anchor" href="#セットアップ" aria-hidden="true">#</a></h2><h3 id="postgresqlのセットアップ" tabindex="-1">PostgreSQLのセットアップ <a class="header-anchor" href="#postgresqlのセットアップ" aria-hidden="true">#</a></h3><h4 id="パフォーマンス・コンフィギュレーション-オプション" tabindex="-1">パフォーマンス・コンフィギュレーション（オプション） <a class="header-anchor" href="#パフォーマンス・コンフィギュレーション-オプション" aria-hidden="true">#</a></h4><p>最適なパフォーマンスを得るためには、<code>systemctl restart postgresql</code>でPostgreSQLを再起動する前に、<a href="https://pgtune.leopard.in.ua/#/" target="_blank" rel="noreferrer">pgTune</a> で適切な設定を生成して <code>/etc/postgresql/15/main/postgresql.conf</code> に値を入れておくとよいでしょう。</p><h4 id="ユーザーの作成" tabindex="-1">ユーザーの作成 <a class="header-anchor" href="#ユーザーの作成" aria-hidden="true">#</a></h4><p>Mastodonが使用できるPostgreSQLユーザを作成する必要があります。つまり、PostgreSQLユーザは個別のパスワードを持たず、Linuxユーザが同じユーザ名で使用できるようにすることです。</p><p>プロンプトを開きます。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-u</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">postgres</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">psql</span></span>
<span class="line"></span></code></pre></div><p>プロンプトで、実行します。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">CREATE</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">USER</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mastodon</span><span style="color:#A6ACCD;"> CREATEDB;</span></span>
<span class="line"><span style="color:#A6ACCD;">\\q</span></span>
<span class="line"></span></code></pre></div><p>完了！</p><h3 id="マストドンのセットアップ" tabindex="-1">マストドンのセットアップ <a class="header-anchor" href="#マストドンのセットアップ" aria-hidden="true">#</a></h3><p>マストドンのコードをダウンロードする時が来ました。マストドン・ユーザーに切り替えてください。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">su</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mastodon</span></span>
<span class="line"></span></code></pre></div><h4 id="コードのチェックアウト" tabindex="-1">コードのチェックアウト <a class="header-anchor" href="#コードのチェックアウト" aria-hidden="true">#</a></h4><p>git を使って Mastodon の最新の安定版リリースをダウンロードしてください。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">clone</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/mastodon/mastodon.git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">live</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">live</span></span>
<span class="line"><span style="color:#FFCB6B;">git</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">checkout</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">git</span><span style="color:#C3E88D;"> tag -l </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">grep</span><span style="color:#C3E88D;"> -v </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">rc[0-9]*$</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;"> </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">sort</span><span style="color:#C3E88D;"> -V </span><span style="color:#89DDFF;">|</span><span style="color:#C3E88D;"> </span><span style="color:#FFCB6B;">tail</span><span style="color:#C3E88D;"> -n </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h4 id="最後の依存関係のインストール" tabindex="-1">最後の依存関係のインストール <a class="header-anchor" href="#最後の依存関係のインストール" aria-hidden="true">#</a></h4><p>次に、RubyとJavaScriptの依存関係をインストールします。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">bundle</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deployment</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">true</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">bundle</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">without</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">development test</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"><span style="color:#FFCB6B;">bundle</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-j</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">getconf</span><span style="color:#C3E88D;"> _NPROCESSORS_ONLN</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#FFCB6B;">yarn</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--pure-lockfile</span></span>
<span class="line"></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>2つの <code>bundle config</code> コマンドが必要なのは、依存関係をインストールする最初のときだけです。もし、後で依存関係を更新したり、再インストールしたりするのであれば、 <code>bundle install</code> だけで十分でしょう。</p></div><h4 id="コンフィギュレーションを生成する" tabindex="-1">コンフィギュレーションを生成する <a class="header-anchor" href="#コンフィギュレーションを生成する" aria-hidden="true">#</a></h4><p>対話型セットアップウィザードを実行します。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">RAILS_ENV</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">production</span><span style="color:#A6ACCD;"> bundle exec rake mastodon:setup</span></span>
<span class="line"></span></code></pre></div><p>これなら</p><ul><li>設定ファイルの作成</li><li>アセット・プリコンパイルの実行</li><li>データベーススキーマの作成</li></ul><p>設定ファイルは <code>.env.production</code> という名前で保存されます。それを見て、お好みで編集することができます。設定に関するドキュメントを参照してください。</p><p>mastodonユーザは一旦終了し、rootに戻ります。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">exit</span></span>
<span class="line"></span></code></pre></div><h3 id="nginxのセットアップ" tabindex="-1">nginxのセットアップ <a class="header-anchor" href="#nginxのセットアップ" aria-hidden="true">#</a></h3><p>Mastodon ディレクトリから nginx 用の設定テンプレートをコピーします。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/home/mastodon/live/dist/nginx.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/sites-available/mastodon</span></span>
<span class="line"><span style="color:#FFCB6B;">ln</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-s</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/sites-available/mastodon</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/nginx/sites-enabled/mastodon</span></span>
<span class="line"></span></code></pre></div><p>次に、<code>/etc/nginx/sites-available/mastodon</code> を編集して <code>example.com</code> を自分のドメイン名に置き換え、その他必要な調整をします。</p><p>変更を有効にするために、nginx をリロードします。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">reload</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"></span></code></pre></div><h3 id="ssl証明書の取得" tabindex="-1">SSL証明書の取得 <a class="header-anchor" href="#ssl証明書の取得" aria-hidden="true">#</a></h3><p>Let&#39;s Encryptを使って、無料のSSL証明書を取得することにします。</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">certbot</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">example.com</span></span>
<span class="line"></span></code></pre></div><p>これは証明書を取得し、新しい証明書を使用するために <code>/etc/nginx/sites-available/mastodon</code> を自動的に更新し、変更を有効にするために nginx を再読み込みします。</p><p>この時点で、ブラウザで自分のドメインにアクセスして、elephant hitting the computer screenのエラーページを見ることができるはずです。これは、まだ Mastodon プロセスを開始していないためです。</p><h3 id="systemd-サービスのセットアップ" tabindex="-1">systemd サービスのセットアップ <a class="header-anchor" href="#systemd-サービスのセットアップ" aria-hidden="true">#</a></h3><p>Mastodon ディレクトリから systemd サービス・テンプレートをコピーします。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/home/mastodon/live/dist/mastodon-</span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.service</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/systemd/system/</span></span>
<span class="line"></span></code></pre></div><p>デフォルトから外れた箇所があれば、ユーザー名とパスが正しいかどうか確認してください。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">$EDITOR /etc/systemd/system/mastodon-</span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;">.service</span></span>
<span class="line"></span></code></pre></div><p>最後に、新しい systemd サービスを起動し、有効化します。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">daemon-reload</span></span>
<span class="line"><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">enable</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--now</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mastodon-web</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mastodon-sidekiq</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mastodon-streaming</span></span>
<span class="line"></span></code></pre></div><p>これで、起動時に自動的に起動するようになります。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><strong>ばんざーい! これだよこれ。これで、ブラウザで自分のドメインにアクセスできるようになりました</strong></p></div>`,79),o=[e];function t(c,r,i,C,y,d){return n(),a("div",null,o)}const h=s(p,[["render",t]]);export{A as __pageData,h as default};
